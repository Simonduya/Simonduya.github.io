<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>mini-vue | Like a Star</title><meta name="author" content="Simon"><meta name="copyright" content="Simon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="reactivityVue.js 是一款流行的前端框架，其最新版本为 Vue 3。Vue 3 中的响应式系统（reactivity system）是其核心特性之一，用于实现数据的双向绑定，使得数据的变化能够自动反映在视图上。下面将使用中文详细介绍 Vue 3 的响应式源码实现。 Vue 3 的响应式系统基于 @vue&#x2F;reactivity 这个包，核心文件是 reactive、effect、com">
<meta property="og:type" content="article">
<meta property="og:title" content="mini-vue">
<meta property="og:url" content="http://example.com/star/fb8a6346.html">
<meta property="og:site_name" content="Like a Star">
<meta property="og:description" content="reactivityVue.js 是一款流行的前端框架，其最新版本为 Vue 3。Vue 3 中的响应式系统（reactivity system）是其核心特性之一，用于实现数据的双向绑定，使得数据的变化能够自动反映在视图上。下面将使用中文详细介绍 Vue 3 的响应式源码实现。 Vue 3 的响应式系统基于 @vue&#x2F;reactivity 这个包，核心文件是 reactive、effect、com">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/category_per.webp">
<meta property="article:published_time" content="2023-07-28T05:03:44.000Z">
<meta property="article:modified_time" content="2023-08-18T07:01:39.525Z">
<meta property="article:author" content="Simon">
<meta property="article:tag" content="mini-vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/category_per.webp"><link rel="shortcut icon" href="/img/head.jpg"><link rel="canonical" href="http://example.com/star/fb8a6346.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'mini-vue',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-18 15:01:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/category_per.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="Like a Star"><span class="site-name">Like a Star</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mini-vue</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-28T05:03:44.000Z" title="发表于 2023-07-28 13:03:44">2023-07-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-18T07:01:39.525Z" title="更新于 2023-08-18 15:01:39">2023-08-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/vue/">vue</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="mini-vue"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="reactivity"><a href="#reactivity" class="headerlink" title="reactivity"></a>reactivity</h1><p>Vue.js 是一款流行的前端框架，其最新版本为 Vue 3。Vue 3 中的响应式系统（reactivity system）是其核心特性之一，用于实现数据的双向绑定，使得数据的变化能够自动反映在视图上。下面将使用中文详细介绍 Vue 3 的响应式源码实现。</p>
<p>Vue 3 的响应式系统基于 <code>@vue/reactivity</code> 这个包，核心文件是 <code>reactive</code>、<code>effect</code>、<code>computed</code> 和 <code>ref</code>。我们将重点介绍 <code>reactive</code> 和 <code>effect</code> 这两个核心函数。</p>
<ol>
<li>reactive 函数：<br><code>reactive</code> 函数用于将一个普通对象转换为响应式对象。当我们使用 <code>reactive</code> 包装一个对象时，这个对象的所有属性都会变成响应式的，也就是说当属性值发生变化时，相关的依赖会被触发。</li>
</ol>
<p>源码中，<code>reactive</code> 函数通过创建一个 Proxy 对象来实现响应式。Proxy 对象拦截对目标对象的访问，从而可以在访问时收集依赖和触发更新。同时，<code>reactive</code> 函数会递归地对目标对象的所有子对象进行响应式转换。</p>
<p>以下是简化版的 <code>reactive</code> 函数的伪代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">target</span>) &#123;</span><br><span class="line">  <span class="comment">// 检查是否已经是响应式对象，如果是则直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isReactive</span>(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建响应式代理对象</span></span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">      <span class="comment">// 收集依赖</span></span><br><span class="line">      <span class="title function_">track</span>(target, key);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="comment">// 触发更新</span></span><br><span class="line">      <span class="keyword">const</span> oldValue = target[key];</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      <span class="title function_">trigger</span>(target, key, value, oldValue);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 其他拦截器：deleteProperty、has 等等</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>effect 函数：<br><code>effect</code> 函数用于创建一个响应式的副作用。它接收一个函数作为参数，该函数会在响应式数据发生改变时被执行。在执行过程中，<code>effect</code> 会自动追踪响应式数据的依赖，并建立响应式数据和副作用函数之间的关联。</li>
</ol>
<p>源码中，<code>effect</code> 函数通过调用副作用函数，并在其中执行响应式数据的访问，从而收集响应式数据的依赖。当响应式数据发生改变时，会触发之前收集的副作用函数重新执行，从而实现自动更新视图。</p>
<p>以下是简化版的 <code>effect</code> 函数的伪代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 创建副作用追踪器</span></span><br><span class="line">  <span class="keyword">const</span> effect = <span class="title function_">createReactiveEffect</span>(fn);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 立即执行一次副作用函数，触发依赖收集</span></span><br><span class="line">  <span class="title function_">effect</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 effect 函数，方便手动调用停止追踪</span></span><br><span class="line">  <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createReactiveEffect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 定义 effect 函数</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="comment">// 执行副作用函数并收集依赖</span></span><br><span class="line">    activeEffect = effect;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fn</span>(...args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是 Vue 3 响应式系统的简要实现。实际的 Vue 3 源码中还包含更多细节和优化，但以上伪代码反映了其基本原理。通过 <code>reactive</code> 函数将对象转换为响应式，通过 <code>effect</code> 函数创建响应式的副作用，Vue 3 实现了高效的数据响应式和自动更新机制，使得开发者可以专注于业务逻辑而无需手动处理视图更新。</p>
<h2 id="实现-effect-reactive"><a href="#实现-effect-reactive" class="headerlink" title="实现 effect + reactive"></a>实现 effect + reactive</h2><h3 id="核心测试代码"><a href="#核心测试代码" class="headerlink" title="核心测试代码"></a>核心测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;effect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">      <span class="attr">age</span>: <span class="number">10</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> nextAge;</span><br><span class="line">    <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      nextAge = user.<span class="property">age</span> + <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">expect</span>(nextAge).<span class="title function_">toBe</span>(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update</span></span><br><span class="line">    user.<span class="property">age</span>++;</span><br><span class="line">    <span class="title function_">expect</span>(nextAge).<span class="title function_">toBe</span>(<span class="number">12</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<ol>
<li>使用 reactive 创建一个响应式对象</li>
<li>使用 effect 函数收集该响应式对象的依赖</li>
</ol>
<ul>
<li>第一次收集依赖就会执行依赖, 所以<code>expect(nextAge).toBe(11);</code></li>
</ul>
<ol start="3">
<li>响应式对象的属性发生变化时会触发依赖<br>总结: get 操作收集依赖, set 操作执行依赖</li>
</ol>
<blockquote>
<p>分析</p>
</blockquote>
<p>这段代码是一个 JavaScript 代码片段，使用了 Vue.js 的 Reactivity API。</p>
<ol>
<li><p>首先，代码使用了 Vue.js 中的<code>reactive</code>函数来创建一个响应式对象<code>user</code>，其中包含一个属性<code>age</code>，初始值为 10。</p>
</li>
<li><p>接着，代码定义了一个变量<code>nextAge</code>，用于存储<code>user.age + 1</code>的计算结果。</p>
</li>
<li><p>然后，代码使用<code>effect</code>函数来创建一个响应式副作用（Reactive Effect）。在 Vue.js 中，响应式副作用会在其依赖的响应式数据发生变化时自动执行。在这里，我们可以理解为当<code>user.age</code>发生变化时，响应式副作用函数内的代码将被触发。</p>
</li>
<li><p>副作用函数内的代码很简单，即将<code>user.age + 1</code>的结果赋值给<code>nextAge</code>。</p>
</li>
<li><p>接下来使用了<code>expect</code>断言来测试<code>nextAge</code>的值。预期的第一个值是<code>11</code>，因为在副作用函数首次运行时，<code>nextAge</code>会被计算为<code>10 + 1</code>，即 11。</p>
</li>
<li><p>然后，代码更新了<code>user.age</code>的值，将其递增 1。</p>
</li>
<li><p>最后，使用<code>expect</code>断言再次测试<code>nextAge</code>的值。预期的结果是<code>12</code>，因为在前面的更新中，<code>user.age</code>已经变为 11，所以再次运行副作用函数时，<code>nextAge</code>会被计算为<code>11 + 1</code>，即 12。</p>
</li>
</ol>
<p>综上所述，这段代码创建了一个包含响应式数据的对象<code>user</code>，并在<code>user.age</code>发生变化时自动更新<code>nextAge</code>的值。这展示了 Vue.js 的 Reactivity API 如何实现响应式数据的自动追踪和更新。</p>
<h3 id="实现-reactive"><a href="#实现-reactive" class="headerlink" title="实现 reactive"></a>实现 reactive</h3><blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>reactive</code> 是一个响应式 API，用于将普通的 JavaScript 对象转换为响应式对象。通过 <code>reactive</code>，我们可以将普通对象转换为响应式数据，使其能够在数据发生变化时自动触发响应式更新，从而实现数据驱动视图的效果。</p>
<p><code>reactive</code> 函数接收一个普通的 JavaScript 对象作为参数，并返回一个包装后的响应式代理对象。这个代理对象会追踪其属性的读取和修改操作，并在属性变化时自动触发依赖更新，从而更新与该数据相关联的视图。</p>
<p>下面是 <code>reactive</code> 的基本用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">foo</span>); <span class="comment">// 输出: &quot;bar&quot;</span></span><br><span class="line"></span><br><span class="line">obj.<span class="property">count</span>++;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">count</span>); <span class="comment">// 输出: 1</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们使用 <code>reactive</code> 创建了一个响应式对象 <code>obj</code>，<code>obj</code> 拥有两个属性 <code>foo</code> 和 <code>count</code>。我们可以像访问普通对象一样访问 <code>obj</code> 的属性，但是在 Vue 3 的响应式系统中，这些属性会被转换为代理对象，并自动追踪依赖。</p>
<p>当我们对 <code>obj</code> 的属性进行修改时，比如对 <code>obj.count</code> 进行自增操作 <code>obj.count++</code>，Vue 3 的响应式系统会检测到这个修改，并自动触发与 <code>obj.count</code> 相关联的组件重新渲染，从而保持视图与数据的同步。</p>
<p>需要注意的是，<code>reactive</code> 只会对对象的直接属性进行代理，不会对对象的原型链上的属性进行代理。如果需要对数组进行响应式处理，可以使用 <code>reactive</code> 配合 <code>ref</code> 或者 <code>reactive</code> 配合 <code>toRefs</code> 进行处理。</p>
<p>总结：<code>reactive</code> 是 Vue 3 中用于创建响应式对象的 API，它可以将普通的 JavaScript 对象转换为响应式数据。通过 <code>reactive</code> 创建的响应式对象，在访问和修改属性时会自动触发依赖更新，从而实现数据驱动视图的效果。</p>
<h4 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;reactive&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> original = &#123;</span><br><span class="line">      <span class="attr">foo</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> observed = <span class="title function_">reactive</span>(original);</span><br><span class="line">    <span class="title function_">expect</span>(observed).<span class="property">not</span>.<span class="title function_">toBe</span>(original);</span><br><span class="line">    <span class="title function_">expect</span>(observed.<span class="property">foo</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>解释： original 为原始的对象，使用 reactive 创建一个响应式对象 observed， 这时候响应式对象 observed 不等于 original 原始对象的，同时响应式对象的 foo 属性值也为 1</p>
<blockquote>
<p>分析</p>
</blockquote>
<p>这段代码是一个 JavaScript 代码片段，使用了 Vue.js 的 Reactivity API 中的<code>reactive</code>函数。</p>
<ol>
<li><p>首先，代码定义了一个普通的 JavaScript 对象<code>original</code>，其中包含一个属性<code>foo</code>，初始值为 1。</p>
</li>
<li><p>接着，代码使用 Vue.js 中的<code>reactive</code>函数来创建一个响应式对象<code>observed</code>，并将<code>original</code>作为参数传递进去。<code>reactive</code>函数的作用是将普通的 JavaScript 对象转换成一个响应式对象，使得该对象的属性变化能够被 Vue.js 的响应系统所追踪。</p>
</li>
<li><p>由于<code>reactive</code>函数会返回一个新的响应式对象，因此代码使用<code>expect</code>断言来检查<code>observed</code>与<code>original</code>不是同一个引用（即不是指向同一内存地址），确保了它们是两个不同的对象。</p>
</li>
<li><p>然后，代码使用另一个<code>expect</code>断言来测试<code>observed</code>的属性<code>foo</code>是否为 1，这是因为<code>original</code>对象的属性<code>foo</code>值为 1，而<code>observed</code>是<code>reactive</code>函数转换后的响应式对象，所以也应该具有相同的属性值。</p>
</li>
</ol>
<p>综上所述，这段代码展示了使用 Vue.js 的<code>reactive</code>函数将普通 JavaScript 对象转换为响应式对象的过程。通过这种方式，我们可以让<code>observed</code>对象的属性变化能够被 Vue.js 的响应系统所捕捉，从而实现自动更新和响应式数据的功能。</p>
<h4 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">raw</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(raw, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="title class_">Reflext</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line">      <span class="comment">// TODO 依赖收集</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="title class_">Reflext</span>.<span class="title function_">set</span>(target, key, value);</span><br><span class="line">      <span class="comment">// TODO 触发依赖</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析</p>
</blockquote>
<p>这段代码是一个简化版的 Vue.js 的<code>reactive</code>函数实现，使用了 JavaScript 的<code>Proxy</code>对象来实现响应式数据的功能。</p>
<ol>
<li><p><code>export function reactive(raw) &#123; ... &#125;</code>: 这是一个导出的函数，用于创建响应式对象。它接收一个参数<code>raw</code>，该参数是一个普通的 JavaScript 对象，需要转换为响应式对象。</p>
</li>
<li><p><code>return new Proxy(raw, &#123; ... &#125;)</code>: 这里使用了<code>Proxy</code>对象来创建一个代理对象，将原始对象<code>raw</code>包装起来。<code>Proxy</code>对象允许我们拦截并自定义对目标对象的操作。</p>
</li>
<li><p><code>get(target, key) &#123; ... &#125;</code>: 这是<code>Proxy</code>的<code>get</code>拦截器方法，当访问响应式对象的属性时，会被触发。<code>target</code>是被代理的原始对象，<code>key</code>是属性名。</p>
</li>
<li><p><code>const res = Reflext.get(target, key);</code>: 这里使用了<code>Reflect.get()</code>方法，实际上是在获取原始对象<code>target</code>的属性<code>key</code>的值，并将结果保存在<code>res</code>变量中。<code>Reflect.get()</code>的作用是获取对象的属性值，类似于直接使用<code>target[key]</code>。</p>
</li>
<li><p><code>// TODO 依赖收集</code>: 这里的注释表示在这个位置应该进行依赖收集的操作。依赖收集是 Vue.js 响应式系统的重要概念，在模板渲染过程中，会追踪响应式数据的依赖关系，当数据发生变化时，能够准确地通知相关的依赖进行更新。</p>
</li>
<li><p><code>return res;</code>: 在<code>get</code>拦截器中，代码直接返回属性的值<code>res</code>，保证了在访问响应式对象的属性时，能够正常获取对应的属性值。</p>
</li>
<li><p><code>set(target, key) &#123; ... &#125;</code>: 这是<code>Proxy</code>的<code>set</code>拦截器方法，当设置响应式对象的属性时，会被触发。<code>target</code>是被代理的原始对象，<code>key</code>是属性名，<code>value</code>是要设置的属性值。</p>
</li>
<li><p><code>const res = Reflext.set(target, key, value);</code>: 这里使用了<code>Reflect.set()</code>方法，实际上是在设置原始对象<code>target</code>的属性<code>key</code>为<code>value</code>。<code>Reflect.set()</code>的作用是设置对象的属性值，类似于直接使用<code>target[key] = value</code>。</p>
</li>
<li><p><code>// TODO 触发依赖</code>: 这里的注释表示在这个位置应该进行触发依赖的操作。当设置响应式对象的属性时，需要通知相关的依赖进行更新，以保证响应式数据的变化能够正确地反映在界面上。</p>
</li>
<li><p><code>return res;</code>: 在<code>set</code>拦截器中，代码直接返回设置的结果<code>res</code>，保证了在设置响应式对象的属性时，能够正常完成属性的赋值。</p>
</li>
</ol>
<p>综上所述，这段代码使用<code>Proxy</code>对象实现了一个简化版的 Vue.js 响应式系统，包括了属性的获取和设置的拦截，并在注释的位置预留了依赖收集和触发依赖的操作。在完整的 Vue.js 中，这些注释部分会涉及更多的逻辑来实现依赖追踪和响应式更新的功能。</p>
<h3 id="实现-effect"><a href="#实现-effect" class="headerlink" title="实现 effect"></a>实现 effect</h3><blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>effect</code> 是一个响应式 API，用于创建一个副作用函数（也称为响应式函数或观察函数）。副作用函数可以用于追踪响应式数据的变化，并在数据变化时执行相应的逻辑。</p>
<p><code>effect</code> 函数接收一个函数作为参数，并返回一个函数。当执行返回的函数时，副作用函数会重新运行。在副作用函数运行期间，它会自动追踪对响应式数据的读取，并建立响应式依赖关系。当这些依赖的响应式数据发生变化时，副作用函数会自动重新运行。</p>
<p>下面是 <code>effect</code> 的基本用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, effect &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> runner = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(state.<span class="property">count</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出: 0</span></span><br><span class="line">state.<span class="property">count</span>++; <span class="comment">// 输出: 1</span></span><br><span class="line">state.<span class="property">count</span>++; <span class="comment">// 输出: 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动执行副作用函数</span></span><br><span class="line"><span class="title function_">runner</span>(); <span class="comment">// 输出: 2</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们首先使用 <code>reactive</code> 创建了一个响应式对象 <code>state</code>，它包含一个属性 <code>count</code>。接着，我们使用 <code>effect</code> 创建了一个副作用函数 <code>runner</code>，这个副作用函数会在 <code>state.count</code> 发生变化时自动运行，并输出当前的 <code>state.count</code> 值。</p>
<p>然后我们对 <code>state.count</code> 进行了两次自增操作，由于 <code>state.count</code> 是响应式数据，所以每次操作都会触发 <code>runner</code> 副作用函数重新运行，并输出更新后的 <code>state.count</code> 值。</p>
<p>最后，我们手动执行了 <code>runner()</code>，这会再次触发副作用函数运行，并输出当前的 <code>state.count</code> 值。</p>
<p>需要注意的是，<code>effect</code> 函数在执行期间会自动建立依赖追踪，这意味着副作用函数会追踪响应式数据的读取操作，但不会追踪非响应式数据的读取。例如，在副作用函数中读取普通变量或全局变量时，不会建立依赖关系，因此对这些非响应式数据的变化不会触发副作用函数的重新运行。</p>
<p>总结：<code>effect</code> 是 Vue 3 中的一个响应式 API，用于创建一个副作用函数。副作用函数可以追踪响应式数据的变化，并在数据变化时执行相应的逻辑。通过 <code>effect</code>，我们可以轻松地实现对响应式数据的监听和响应式逻辑的处理。</p>
<h4 id="step1-实现第一次收集依赖时，-会执行传入的-fn"><a href="#step1-实现第一次收集依赖时，-会执行传入的-fn" class="headerlink" title="step1 实现第一次收集依赖时， 会执行传入的 fn"></a>step1 实现第一次收集依赖时， 会执行传入的 fn</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;effect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">      <span class="attr">age</span>: <span class="number">10</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> nextAge;</span><br><span class="line">    <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      nextAge = user.<span class="property">age</span> + <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">expect</span>(nextAge).<span class="title function_">toBe</span>(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// // update</span></span><br><span class="line">    <span class="comment">// user.age++;</span></span><br><span class="line">    <span class="comment">// expect(nextAge).toBe(12);</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析</p>
</blockquote>
<p>这段代码是一个简单的 JavaScript&#x2F;TypeScript 代码段，它实现了一个名为 <code>ReactiveEffect</code> 的类和一个 <code>effect</code> 函数。</p>
<ol>
<li><p><code>ReactiveEffect</code> 类：</p>
<ul>
<li>这个类有一个私有成员 <code>_fn</code>，它是一个函数类型的变量。</li>
<li>构造函数 <code>constructor(fn)</code> 接收一个函数 <code>fn</code> 作为参数，并将其存储在私有成员 <code>_fn</code> 中。</li>
<li><code>run()</code> 方法用于执行存储在 <code>_fn</code> 中的函数。</li>
</ul>
</li>
<li><p><code>effect</code> 函数：</p>
<ul>
<li>这个函数是一个导出的函数，意味着其他文件可以导入并使用它。</li>
<li>它接收一个函数 <code>fn</code> 作为参数。</li>
<li>在函数内部，它创建一个新的 <code>ReactiveEffect</code> 实例 <code>_effect</code>，并将传入的函数 <code>fn</code> 作为参数传递给构造函数。</li>
<li>然后，它立即调用 <code>_effect</code> 对象的 <code>run()</code> 方法，从而执行传入的函数 <code>fn</code>。</li>
</ul>
</li>
</ol>
<p>这个代码的作用是实现一个简单的“响应式”效果。传入的函数 <code>fn</code> 在调用 <code>effect(fn)</code> 的时候会立即执行，从而实现了响应式的效果。也就是说，每当调用 <code>effect(fn)</code> 时，<code>fn</code> 都会被立即执行一次。</p>
<p>例如，如果有以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Doing something!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>(doSomething);</span><br></pre></td></tr></table></figure>

<p>输出将会是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Doing something!</span><br></pre></td></tr></table></figure>

<p>需要注意的是，这里的响应式效果非常简单，仅在调用 <code>effect(fn)</code> 时触发一次传入的函数 <code>fn</code>。在实际的响应式编程中，可能会涉及更多的状态管理和触发机制，用于在数据发生变化时触发相关的响应函数。</p>
<h4 id="step2-实现收集和触发依赖"><a href="#step2-实现收集和触发依赖" class="headerlink" title="step2 实现收集和触发依赖"></a>step2 实现收集和触发依赖</h4><ul>
<li>收集依赖 track<br>映射关系： target -&gt; key -&gt; dep<br>一个容器可能保存了多个响应式对象，通过 target 来获取某个响应式对象对应的依赖，同时需要使用某个 target 具体的 key 来获取该对象某个属性对应的依赖函数。</li>
</ul>
<p>每个响应式对象的每一个 key 需要有对应的依赖容器 dep， 并且该容器 dep 中的依赖 fn 不能够重复，所以我们使用 set 这种数据结构来收集依赖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reactive.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">raw</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(raw, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="title class_">Reflext</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line">      <span class="comment">// TODO 依赖收集</span></span><br><span class="line">      <span class="title function_">track</span>(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="title class_">Reflext</span>.<span class="title function_">set</span>(target, key, value);</span><br><span class="line">      <span class="comment">// TODO 触发依赖</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析</p>
</blockquote>
<p>这段代码是一个简单的响应式系统，用于实现响应式效果。它包含了三个主要的类和函数：</p>
<ol>
<li><p><code>ReactiveEffect</code> 类：这是一个构造函数，用于创建响应式效果对象。它接收一个函数 <code>fn</code> 作为参数，并将其保存在私有属性 <code>_fn</code> 中。<code>ReactiveEffect</code> 类有一个 <code>run()</code> 方法，当调用该方法时，会将当前的 <code>activeEffect</code> 设置为自己，并执行保存的函数 <code>_fn</code>。</p>
</li>
<li><p><code>track()</code> 函数：这个函数用于建立响应式依赖。它接收两个参数 <code>target</code> 和 <code>key</code>，代表目标对象和对象的属性。<code>track()</code> 函数会根据目标对象和属性，在 <code>targetMap</code> 中建立对应的依赖关系。<code>targetMap</code> 是一个 <code>Map</code> 对象，用于保存所有目标对象的依赖关系。每个目标对象对应一个 <code>depsMap</code>，其中键是属性名，值是一个 <code>Set</code> 对象，用于保存依赖于该属性的所有响应式效果对象。</p>
</li>
<li><p><code>effect()</code> 函数：这个函数用于创建一个响应式效果。它接收一个函数 <code>fn</code> 作为参数，并将其传递给 <code>ReactiveEffect</code> 类的实例 <code>_effect</code>。然后，它立即调用 <code>_effect</code> 的 <code>run()</code> 方法，触发执行保存的函数，同时会将当前的 <code>_effect</code> 设置为全局变量 <code>activeEffect</code>。这样在 <code>fn</code> 中如果有响应式数据被访问，<code>track()</code> 函数就会被调用，建立相应的依赖关系。</p>
</li>
</ol>
<p>总的来说，这段代码是一个简单的响应式系统，用于追踪对象属性的依赖关系，当依赖的数据发生变化时，会触发相应的响应式效果函数的执行。这类响应式系统在实现前端框架的数据绑定和视图更新等功能上非常常见。</p>
<ul>
<li>触发依赖 trigger<br>基于 target, key 取出所有的 fn， 并且执行</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reactive.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">raw</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(raw, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="title class_">Reflext</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line">      <span class="comment">// TODO 依赖收集</span></span><br><span class="line">      <span class="title function_">track</span>(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="title class_">Reflext</span>.<span class="title function_">set</span>(target, key, value);</span><br><span class="line">      <span class="comment">// TODO 触发依赖</span></span><br><span class="line">      <span class="title function_">trigger</span>(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        effect.<span class="title function_">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终通过核心测试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;effect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">      <span class="attr">age</span>: <span class="number">10</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> nextAge;</span><br><span class="line">    <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      nextAge = user.<span class="property">age</span> + <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">expect</span>(nextAge).<span class="title function_">toBe</span>(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update</span></span><br><span class="line">    user.<span class="property">age</span>++;</span><br><span class="line">    <span class="title function_">expect</span>(nextAge).<span class="title function_">toBe</span>(<span class="number">12</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="完善-effect"><a href="#完善-effect" class="headerlink" title="完善 effect"></a>完善 effect</h3><h4 id="effect-返回新函数-runner"><a href="#effect-返回新函数-runner" class="headerlink" title="effect 返回新函数 runner"></a>effect 返回新函数 runner</h4><p>当执行 effect 后， effect 函数会返回一个新的函数叫做 runner， 当调用 runner 时， 会再次执行传给 effect 的 fn， 当调用 fn 时， 会把 fn 的返回值 return， 也就是调用 runner 可以拿到内部 fn 返回的值</p>
<p>effect 函数的功能，即接收一个函数作为参数，执行该函数，并返回一个新的函数 runner，该函数可以再次执行传入的函数，并返回其返回值</p>
<p>测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;should return runner when call effect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// effect(fn) -&gt; function runner() -&gt; fn -&gt; return</span></span><br><span class="line">  <span class="keyword">let</span> foo = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">const</span> runner = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    foo++;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;foo&quot;</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">//  执行effect就会执行fn</span></span><br><span class="line">  <span class="title function_">expect</span>(foo).<span class="title function_">toBe</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">const</span> res = <span class="title function_">runner</span>();</span><br><span class="line">  <span class="comment">//   调用runner时再次执行fn</span></span><br><span class="line">  <span class="title function_">expect</span>(foo).<span class="title function_">toBe</span>(<span class="number">12</span>);</span><br><span class="line">  <span class="comment">//   可以拿到fn的返回值</span></span><br><span class="line">  <span class="title function_">expect</span>(res).<span class="title function_">toBe</span>(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>实现代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        effect.<span class="title function_">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">return</span> _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">    <span class="comment">//_effect.run.bind(_effect) 的结果是一个新的函数，这个新函数的执行上下文（this值）被绑定到 _effect 实例上。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析</p>
</blockquote>
<p><code>return _effect.run.bind(_effect);</code><br>这段代码的意思是返回一个新的函数，这个函数是<code>_effect.run</code>方法绑定到<code>_effect</code>实例上的结果。</p>
<p>让我们来分解这段代码的含义：</p>
<ol>
<li><p><code>_effect</code> 是一个 <code>ReactiveEffect</code> 类的实例，它具有一个名为 <code>run</code> 的方法。</p>
</li>
<li><p><code>_effect.run</code> 是对 <code>_effect</code> 实例中的 <code>run</code> 方法的引用，但是并没有调用它。</p>
</li>
<li><p><code>bind</code> 是 JavaScript 中的一个函数方法，它可以用于创建一个新的函数，将指定的对象绑定为新函数的上下文（也就是函数内部的<code>this</code>值）。</p>
</li>
<li><p><code>_effect.run.bind(_effect)</code> 的结果是一个新的函数，这个新函数的执行上下文（<code>this</code>值）被绑定到 <code>_effect</code> 实例上。</p>
</li>
<li><p>最终，<code>return _effect.run.bind(_effect);</code> 将这个新函数作为<code>effect</code>函数的返回值。</p>
</li>
</ol>
<p>这个返回的新函数可以在其他地方被调用，当它被调用时，它会以 <code>_effect</code> 实例为上下文（<code>this</code> 值），然后执行 <code>_effect.run()</code> 方法，从而再次运行原始的函数，也就是之前传递给 <code>effect</code> 函数的那个函数。</p>
<p>在你的测试用例中，你将这个返回的新函数存储在变量 <code>runner</code> 中，并在后续的测试中调用它，这样就可以多次触发原始的函数运行，以验证其效果。</p>
<h4 id="effect-的-scheduler-功能"><a href="#effect-的-scheduler-功能" class="headerlink" title="effect 的 scheduler 功能"></a>effect 的 scheduler 功能</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;scheduler&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 1. 通过 effect 的第二个参数给定一个scheduler的fn</span></span><br><span class="line">  <span class="comment">// 2. effect第一次执行的时候还会执行fn, 而不会执行scheduler</span></span><br><span class="line">  <span class="comment">// 3. 当 响应式对象执行set操作 update 时不会执行fn 而是执行 scheduler</span></span><br><span class="line">  <span class="comment">// 4. 如果说当执行runner的时候, 会再次执行fn</span></span><br><span class="line">  <span class="keyword">let</span> dummy;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">run</span>: any;</span><br><span class="line">  <span class="keyword">const</span> scheduler = jest.<span class="title function_">fn</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    run = runner;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123; <span class="attr">foo</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  <span class="keyword">const</span> runner = <span class="title function_">effect</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      dummy = obj.<span class="property">foo</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; scheduler &#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="title function_">expect</span>(scheduler).<span class="property">not</span>.<span class="title function_">toHaveBeenCalled</span>();</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// should be called on first trigger</span></span><br><span class="line">  obj.<span class="property">foo</span>++;</span><br><span class="line">  <span class="title function_">expect</span>(scheduler).<span class="title function_">toHaveBeenCalledTimes</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// should not run yet</span></span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// manually run</span></span><br><span class="line">  <span class="title function_">run</span>();</span><br><span class="line">  <span class="comment">// should have run</span></span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析</p>
</blockquote>
<p>这段代码是一个测试用例，用于测试一个调度器（scheduler）函数在响应式系统中的工作情况。下面我会逐步解释这段代码的作用：</p>
<ol>
<li><p>首先，你定义了一些变量 <code>dummy</code> 和 <code>run</code>。</p>
</li>
<li><p>接着，你创建了一个名为 <code>scheduler</code> 的 Jest Mock 函数，用于模拟调度器的行为。调度器函数在响应式系统中负责管理副作用（effects）的执行时机。</p>
</li>
<li><p>然后，你使用 <code>reactive</code> 函数创建了一个名为 <code>obj</code> 的响应式对象，其中包含一个属性 <code>foo</code>，初始值为 1。</p>
</li>
<li><p>接下来，你调用了 <code>effect</code> 函数来创建一个副作用（effect）。这个副作用会将 <code>obj.foo</code> 的值赋给 <code>dummy</code> 变量。</p>
</li>
<li><p>在调用 <code>effect</code> 函数时，你传递了一个选项对象 <code>&#123; scheduler &#125;</code>，这样在副作用执行时会使用指定的调度器函数。</p>
</li>
<li><p>在测试开始时，你检查 <code>scheduler</code> 函数还没有被调用过，然后检查 <code>dummy</code> 的值是否为 1。</p>
</li>
<li><p>接下来，你通过对 <code>obj.foo</code> 的赋值来触发副作用。这里的响应式系统会调用调度器函数，但是注意此时副作用还没有被执行。</p>
</li>
<li><p>你再次检查 <code>scheduler</code> 函数是否被调用了一次，然后检查 <code>dummy</code> 的值是否仍然为 1。这是因为副作用尚未执行，只是被调度了。</p>
</li>
<li><p>接下来，你调用了之前定义的 <code>run</code> 函数，手动触发副作用的执行。</p>
</li>
<li><p>最后，你检查 <code>dummy</code> 的值是否变成了 2，这是因为 <code>run</code> 函数的调用导致副作用执行，<code>dummy</code> 被更新为 <code>obj.foo</code> 的新值。</p>
</li>
</ol>
<p>总结来说，这个测试用例验证了调度器函数的作用，它确保副作用在适当的时机得到执行，并且通过手动调用 <code>run</code> 函数，你可以手动触发副作用的执行，而不必等待自动触发。</p>
<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn, public shceduler?</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effect.<span class="title function_">shceduler</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effect.<span class="title function_">run</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options: any = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scheduler = options.<span class="property">scheduler</span>;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn, scheduler);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">return</span> _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="effect-的-stop-功能"><a href="#effect-的-stop-功能" class="headerlink" title="effect 的 stop 功能"></a>effect 的 stop 功能</h4><p>stop 用于控制一个响应式对象的副作用执行。调用 stop 后会暂停该副作用， 再次执行 runner 函数后副作用又可以继续执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;stop&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dummy;</span><br><span class="line">  <span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123; <span class="attr">prop</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  <span class="keyword">const</span> runner = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    dummy = obj.<span class="property">prop</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  obj.<span class="property">prop</span> = <span class="number">2</span>;</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="title function_">stop</span>(runner);</span><br><span class="line">  obj.<span class="property">prop</span> = <span class="number">3</span>;</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">runner</span>();</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>调用 stop 的时候将 effect 从 deps 中移除</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private _fn = any;</span><br><span class="line">    deps = [];</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn, public scheduler?</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep: any</span>) =&gt;</span> &#123;</span><br><span class="line">            dep.<span class="title function_">delete</span>(<span class="variable language_">this</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">    activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effect.<span class="title function_">shceduler</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effect.<span class="title function_">run</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params">runner</span>) &#123;</span><br><span class="line">    runner.<span class="property">effect</span>.<span class="title function_">stop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options: any = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scheduler = options.<span class="property">scheduler</span>;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn, scheduler);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">runner</span>: any = _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">    runner.<span class="property">effect</span> = _effect;</span><br><span class="line">    <span class="keyword">return</span> runner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h4><ol>
<li>抽离删除依赖的逻辑并添加清空与否的状态</li>
<li>有了清空状态，那外界调用多次 stop 也只会清空一次</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    deps = [];</span><br><span class="line">    <span class="attr">active</span>: <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn, public scheduler?</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">            <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanupEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    effect.<span class="property">deps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep: any</span>) =&gt;</span> &#123;</span><br><span class="line">        dep.<span class="title function_">delete</span>(effect);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">    activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effect.<span class="title function_">shceduler</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effect.<span class="title function_">run</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params">runner</span>) &#123;</span><br><span class="line">    runner.<span class="property">effect</span>.<span class="title function_">stop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options: any = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scheduler = options.<span class="property">scheduler</span>;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn, scheduler);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">runner</span>: any = _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">    runner.<span class="property">effect</span> = _effect;</span><br><span class="line">    <span class="keyword">return</span> runner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="effect-的-onStop-功能"><a href="#effect-的-onStop-功能" class="headerlink" title="effect 的 onStop 功能"></a>effect 的 onStop 功能</h4><p>当执行 stop 函数时进行的回调， 允许用户进行额外的操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;onStop&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> onStop = jest.<span class="title function_">fn</span>();</span><br><span class="line">  <span class="keyword">let</span> dummy;</span><br><span class="line">  <span class="keyword">const</span> runner = <span class="title function_">effect</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      dummy = obj.<span class="property">foo</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      onStop,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="title function_">stop</span>(runner);</span><br><span class="line">  <span class="title function_">expect</span>(onStop).<span class="title function_">toBeCalledTimes</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    deps = [];</span><br><span class="line">    active = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// onStop是可选的</span></span><br><span class="line">    onStop?:<span class="function">() =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    public <span class="attr">scheduler</span>: <span class="title class_">Function</span> | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn, scheduler?: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scheduler</span> = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">            <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="comment">// 如果onStop有值的话就进行回调</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">onStop</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onStop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanupEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    effect.<span class="property">deps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep: any</span>) =&gt;</span> &#123;</span><br><span class="line">        dep.<span class="title function_">delete</span>(effect);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">    activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effect.<span class="title function_">shceduler</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effect.<span class="title function_">run</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params">runner</span>) &#123;</span><br><span class="line">    runner.<span class="property">effect</span>.<span class="title function_">stop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options: any = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn, options.<span class="property">scheduler</span>);</span><br><span class="line">    <span class="comment">// 保存onStop</span></span><br><span class="line">    _effect.<span class="property">onStop</span> = options.<span class="property">onStop</span>;</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">runner</span>: any = _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">    runner.<span class="property">effect</span> = _effect;</span><br><span class="line">    <span class="keyword">return</span> runner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="代码优化-1"><a href="#代码优化-1" class="headerlink" title="代码优化"></a>代码优化</h4><ol>
<li>可能有更多的 options， 所以可以使用 Object.assign 进行操作</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    deps = [];</span><br><span class="line">    active = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// onStop是可选的</span></span><br><span class="line">    onStop?:<span class="function">() =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    public <span class="attr">scheduler</span>: <span class="title class_">Function</span> | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn, scheduler?: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scheduler</span> = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">            <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="comment">// 如果onStop有值的话就进行回调</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">onStop</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onStop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanupEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    effect.<span class="property">deps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep: any</span>) =&gt;</span> &#123;</span><br><span class="line">        dep.<span class="title function_">delete</span>(effect);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!activeEffect) <span class="keyword">return</span>;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">    activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effect.<span class="title function_">shceduler</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effect.<span class="title function_">run</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params">runner</span>) &#123;</span><br><span class="line">    runner.<span class="property">effect</span>.<span class="title function_">stop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options: any = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn, options.<span class="property">scheduler</span>);</span><br><span class="line">    <span class="comment">// 保存onStop</span></span><br><span class="line">    <span class="comment">// _effect.onStop = options.onStop;</span></span><br><span class="line">    <span class="comment">// 使用Object.assign进行优化</span></span><br><span class="line">    <span class="comment">// Object.assign(_effect, options);</span></span><br><span class="line">    <span class="comment">// 使用extend更加语义化</span></span><br><span class="line">    <span class="title function_">extend</span>(_effect, options);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">runner</span>: any = _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">    runner.<span class="property">effect</span> = _effect;</span><br><span class="line">    <span class="keyword">return</span> runner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> extend = <span class="title class_">Object</span>.<span class="property">assign</span>;</span><br></pre></td></tr></table></figure>

<h4 id="effect-边缘情况-obj-prop"><a href="#effect-边缘情况-obj-prop" class="headerlink" title="effect 边缘情况, obj.prop++"></a>effect 边缘情况, obj.prop++</h4><h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><p>这里的测试是无法通过的, 因为<code>obj.prop++</code>即触发了 get 操作, 又触发了 set 操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;stop&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dummy;</span><br><span class="line">  <span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123; <span class="attr">prop</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  <span class="keyword">const</span> runner = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    dummy = obj.<span class="property">prop</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// obj.prop = 2;</span></span><br><span class="line">  <span class="comment">// obj.prop = obj.prop + 1;</span></span><br><span class="line">  <span class="comment">// 同时触发get和set操作</span></span><br><span class="line">  obj.<span class="property">prop</span>++;</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="title function_">stop</span>(runner);</span><br><span class="line">  obj.<span class="property">prop</span> = <span class="number">3</span>;</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">runner</span>();</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="实现代码-1"><a href="#实现代码-1" class="headerlink" title="实现代码"></a>实现代码</h5><p>新增 shouldTrack 变量用于控制 get 操作时是否收集依赖</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">let</span> shouldTrack = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    deps = [];</span><br><span class="line">    active = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// onStop是可选的</span></span><br><span class="line">    onStop?:<span class="function">() =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    public <span class="attr">scheduler</span>: <span class="title class_">Function</span> | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn, scheduler?: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scheduler</span> = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// activeEffect = this;</span></span><br><span class="line">        <span class="comment">// return this._fn();</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        shouldTrack = <span class="literal">true</span>;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">        <span class="comment">// reset</span></span><br><span class="line">        shouldTrack = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">            <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="comment">// 如果onStop有值的话就进行回调</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">onStop</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onStop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanupEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    effect.<span class="property">deps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep: any</span>) =&gt;</span> &#123;</span><br><span class="line">        dep.<span class="title function_">delete</span>(effect);</span><br><span class="line">    &#125;)</span><br><span class="line">    effect.<span class="property">deps</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!activeEffect) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(!shouldTrack) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">    activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effect.<span class="title function_">shceduler</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effect.<span class="title function_">run</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params">runner</span>) &#123;</span><br><span class="line">    runner.<span class="property">effect</span>.<span class="title function_">stop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options: any = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn, options.<span class="property">scheduler</span>);</span><br><span class="line">    <span class="comment">// 保存onStop</span></span><br><span class="line">    <span class="comment">// _effect.onStop = options.onStop;</span></span><br><span class="line">    <span class="comment">// 使用Object.assign进行优化</span></span><br><span class="line">    <span class="comment">// Object.assign(_effect, options);</span></span><br><span class="line">    <span class="comment">// 使用extend更加语义化</span></span><br><span class="line">    <span class="title function_">extend</span>(_effect, options);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">runner</span>: any = _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">    runner.<span class="property">effect</span> = _effect;</span><br><span class="line">    <span class="keyword">return</span> runner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析</p>
</blockquote>
<p>详细分析 <code>run</code> 方法和 <code>shouldTrack</code> 变量的作用：</p>
<ol>
<li><p><code>run()</code> 方法：</p>
<p><code>run()</code> 方法是 <code>ReactiveEffect</code> 类的一个关键方法，它用于执行副作用函数（也就是用户定义的响应式函数）并追踪其依赖关系。</p>
<ul>
<li>首先，它会检查 <code>this.active</code> 是否为 <code>false</code>，如果是，则表示该副作用函数已经被停止（通过 <code>stop</code> 方法实现），直接返回执行结果 <code>_fn()</code>。</li>
<li>如果 <code>this.active</code> 不为 <code>false</code>，则说明该副作用函数是活动的，可以追踪依赖关系。在这种情况下，它将 <code>shouldTrack</code> 变量设为 <code>true</code>，这是为了在副作用函数执行期间让 <code>track</code> 函数知道当前正在追踪依赖关系，而不是由其他非响应式代码触发的读取操作。</li>
<li>接着，它将 <code>activeEffect</code> 设置为当前的 <code>ReactiveEffect</code> 对象，这是为了在副作用函数内部可以通过 <code>activeEffect</code> 引用到当前正在执行的副作用函数对象，从而将其注册到依赖关系中。</li>
<li>然后，它执行副作用函数 <code>_fn()</code>，这个函数是用户定义的响应式函数，通常会对响应式数据进行读取操作（get）。</li>
<li>最后，它将 <code>shouldTrack</code> 重新设为 <code>false</code>，表示当前副作用函数执行结束，不再追踪依赖关系。</li>
</ul>
</li>
<li><p><code>shouldTrack</code> 变量：</p>
<p><code>shouldTrack</code> 是一个用于标记当前是否应该追踪依赖关系的布尔变量。</p>
<p>在响应式系统中，为了在副作用函数执行期间知道是否正在进行依赖追踪，我们需要在执行 <code>track</code> 和 <code>trigger</code> 函数时设置一个标志。这个标志就是 <code>shouldTrack</code>。</p>
<ul>
<li>当 <code>shouldTrack</code> 为 <code>true</code> 时，表示当前正在进行依赖追踪，此时会将副作用函数注册到相关依赖中。</li>
<li>当 <code>shouldTrack</code> 为 <code>false</code> 时，表示当前不需要进行依赖追踪，通常是因为正在执行一些非响应式的普通代码，而不是由响应式数据的读取操作触发的。</li>
</ul>
<p><code>shouldTrack</code> 变量的设置和重置是通过 <code>run</code> 方法中的逻辑来实现的。在副作用函数执行期间，<code>shouldTrack</code> 被设置为 <code>true</code>，以便在执行读取操作时进行依赖追踪，而在副作用函数执行结束后，它被重置为 <code>false</code>，以便在执行非响应式代码时不进行依赖追踪。</p>
</li>
</ol>
<p>总结：<code>run</code> 方法是响应式系统中用于执行副作用函数和追踪依赖关系的核心方法。<code>shouldTrack</code> 变量是用于在副作用函数执行期间标记是否进行依赖追踪的布尔变量。这两者在响应式系统的运行中起到了关键作用，保证了依赖关系的正确追踪和副作用函数的准确执行。</p>
<h5 id="代码优化-2"><a href="#代码优化-2" class="headerlink" title="代码优化"></a>代码优化</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effect.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">let</span> shouldTrack = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReactiveEffect</span> &#123;</span><br><span class="line">    private <span class="attr">_fn</span>: any;</span><br><span class="line">    deps = [];</span><br><span class="line">    active = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// onStop是可选的</span></span><br><span class="line">    onStop?:<span class="function">() =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    public <span class="attr">scheduler</span>: <span class="title class_">Function</span> | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">fn, scheduler?: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fn</span> = fn;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scheduler</span> = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// activeEffect = this;</span></span><br><span class="line">        <span class="comment">// return this._fn();</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        shouldTrack = <span class="literal">true</span>;</span><br><span class="line">        activeEffect = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="variable language_">this</span>.<span class="title function_">_fn</span>();</span><br><span class="line">        <span class="comment">// reset</span></span><br><span class="line">        shouldTrack = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">            <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="comment">// 如果onStop有值的话就进行回调</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">onStop</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onStop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanupEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">    effect.<span class="property">deps</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep: any</span>) =&gt;</span> &#123;</span><br><span class="line">        dep.<span class="title function_">delete</span>(effect);</span><br><span class="line">    &#125;)</span><br><span class="line">    effect.<span class="property">deps</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isTracking</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> shouldTrack &amp;&amp; activeEffect !== <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_">isTracking</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">        dep = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, dep);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 已经在dep中了</span></span><br><span class="line">    <span class="keyword">if</span> (dep.<span class="title function_">has</span>(activeEffect)) <span class="keyword">return</span>;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">    activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">            effect.<span class="title function_">shceduler</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            effect.<span class="title function_">run</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stop</span>(<span class="params">runner</span>) &#123;</span><br><span class="line">    runner.<span class="property">effect</span>.<span class="title function_">stop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn, options: any = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn, options.<span class="property">scheduler</span>);</span><br><span class="line">    <span class="comment">// 保存onStop</span></span><br><span class="line">    <span class="comment">// _effect.onStop = options.onStop;</span></span><br><span class="line">    <span class="comment">// 使用Object.assign进行优化</span></span><br><span class="line">    <span class="comment">// Object.assign(_effect, options);</span></span><br><span class="line">    <span class="comment">// 使用extend更加语义化</span></span><br><span class="line">    <span class="title function_">extend</span>(_effect, options);</span><br><span class="line">    _effect.<span class="title function_">run</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">runner</span>: any = _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect);</span><br><span class="line">    runner.<span class="property">effect</span> = _effect;</span><br><span class="line">    <span class="keyword">return</span> runner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-readonly"><a href="#实现-readonly" class="headerlink" title="实现 readonly"></a>实现 readonly</h2><p>readonly 和 reactive 很像， 无非就是不能进行 set 操作<br>不会进行触发依赖， 也就不需要进行依赖收集</p>
<blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>readonly</code> 是一个新的响应式 API，它用于创建一个只读（read-only）的响应式代理对象。这意味着一旦创建了 <code>readonly</code> 对象，你将无法直接修改它的属性或方法。这个 API 对于保护数据不被意外修改以及在应用程序中实现更严格的状态管理非常有用。</p>
<p>使用 <code>readonly</code>，你可以将一个普通的对象或数组转换成只读的响应式对象，使其成为一个不可变的数据源。这样做可以避免在应用程序中无意中修改了数据，特别是在开发大型项目或与其他开发人员合作时非常有用。</p>
<p>要使用 <code>readonly</code>，你需要在 Vue 组件的 <code>setup</code> 函数中调用 <code>readonly</code> 方法来创建只读的响应式代理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; readonly &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 普通对象</span></span><br><span class="line">  <span class="keyword">const</span> myObject = <span class="title function_">readonly</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 数组</span></span><br><span class="line">  <span class="keyword">const</span> myArray = <span class="title function_">readonly</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 可以在这里使用 myObject 和 myArray，但不能直接修改它们</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，<code>myObject</code> 和 <code>myArray</code> 是只读的，你不能通过直接赋值修改它们的属性或索引。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误示例</span></span><br><span class="line">myObject.<span class="property">name</span> = <span class="string">&quot;Jane&quot;</span>; <span class="comment">// 无效，因为 myObject 是只读的</span></span><br><span class="line">myArray[<span class="number">0</span>] = <span class="number">10</span>; <span class="comment">// 无效，因为 myArray 是只读的</span></span><br></pre></td></tr></table></figure>

<p>注意，<code>readonly</code> 只会保护代理对象本身及其一级属性。如果你在只读对象中有一个属性是对象或数组，那么该属性仍然可以被修改。为了深层次的只读保护，你需要递归地将每个嵌套对象或数组也转换为只读的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; readonly &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myNestedObject = <span class="title function_">readonly</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">  <span class="attr">address</span>: <span class="title function_">readonly</span>(&#123;</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&quot;New York&quot;</span>,</span><br><span class="line">    <span class="attr">country</span>: <span class="string">&quot;USA&quot;</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，<code>myNestedObject</code> 中的 <code>address</code> 对象仍然是只读的，无法直接修改它的属性。</p>
<p>总结一下，<code>readonly</code> 是 Vue 3 中一个强大的响应式 API，可以将普通对象和数组转换为只读的响应式代理，以提供更好的数据保护和状态管理。然而，要注意只有第一级属性是只读的，对于嵌套对象或数组，你需要递归地应用 <code>readonly</code> 来实现深层次的只读保护。</p>
<h3 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// not set</span></span><br><span class="line">  <span class="keyword">const</span> original = &#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">bar</span>: &#123;</span><br><span class="line">      <span class="attr">baz</span>: <span class="number">2</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> wrapped = <span class="title function_">readonly</span>(original);</span><br><span class="line">  <span class="title function_">expect</span>(wrapped).<span class="property">not</span>.<span class="title function_">toBe</span>(original);</span><br><span class="line">  <span class="title function_">expect</span>(wrapped.<span class="property">foo</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-2"><a href="#实现代码-2" class="headerlink" title="实现代码"></a>实现代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">readonly</span>(<span class="params">raw</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(raw, &#123;</span><br><span class="line">        <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">set</span>(<span class="params">target, key, value</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当进行 set 操作的时候进行 warn</p>
<p>测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;warn when call set&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// console.warn();</span></span><br><span class="line">  <span class="comment">// mock</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="property">warn</span> = jest.<span class="title function_">fn</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">readonly</span>(&#123;</span><br><span class="line">    <span class="attr">age</span>: <span class="number">10</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  user.<span class="property">age</span> = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">expect</span>(<span class="variable language_">console</span>.<span class="property">warn</span>).<span class="title function_">toBeCalled</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>实现代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">readonly</span>(<span class="params">raw</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(raw, &#123;</span><br><span class="line">        <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">set</span>(<span class="params">target, key, value</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`key:<span class="subst">$&#123;key&#125;</span> can not set , because target is readonly`</span>, target);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-isReactive"><a href="#实现-isReactive" class="headerlink" title="实现 isReactive"></a>实现 isReactive</h2><blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>isReactive</code> 是一个函数，用于检查一个对象是否是响应式的。响应式对象是通过 Vue 的响应式系统追踪变化的对象，当其属性发生变化时，可以自动触发视图更新。</p>
<p><code>isReactive</code> 函数接受一个参数，即要检查的对象，并返回一个布尔值，表示该对象是否是响应式的。</p>
<p>使用 <code>isReactive</code>，你可以在代码中检查一个对象是否已经被转换为响应式对象。这在开发过程中是很有用的，特别是当你需要确认某个对象是否已经具备响应式特性，或者用于调试和验证目的。</p>
<p>下面是一个使用 <code>isReactive</code> 的简单示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, isReactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myObject = <span class="title function_">reactive</span>(&#123; <span class="attr">name</span>: <span class="string">&quot;John&quot;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReactive</span>(myObject)); <span class="comment">// 输出：true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReactive</span>(&#123; <span class="attr">name</span>: <span class="string">&quot;Jane&quot;</span> &#125;)); <span class="comment">// 输出：false，因为这个对象不是响应式的</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们通过 <code>reactive</code> 将 <code>myObject</code> 转换为响应式对象，并使用 <code>isReactive</code> 检查该对象是否是响应式的，结果返回 <code>true</code>。</p>
<p>需要注意的是，<code>isReactive</code> 只能用于检查通过 Vue 提供的响应式 API（例如 <code>reactive</code>、<code>ref</code> 等）转换的对象，而不能用于原生 JavaScript 对象。</p>
<p>总结一下，<code>isReactive</code> 是 Vue 3 中的一个实用函数，用于检查一个对象是否是响应式的。它返回一个布尔值，表示该对象是否具备响应式特性，这在开发过程中有助于验证和调试。</p>
<h3 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> original = &#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> observed = <span class="title function_">reactive</span>(original);</span><br><span class="line">  <span class="title function_">expect</span>(observed).<span class="property">not</span>.<span class="title function_">toBe</span>(original);</span><br><span class="line">  <span class="title function_">expect</span>(observed.<span class="property">foo</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isReactive</span>(observed)).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isReactive</span>(original)).<span class="title function_">toBe</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-3"><a href="#实现代码-3" class="headerlink" title="实现代码"></a>实现代码</h3><p>触发 get 操作即可判断 isReactive;<br>访问 value 的某个属性即可触发 get 操作;<br>触发 get 操作的时候 isReadonly 取反即可;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> enum <span class="title class_">ReactiveFlags</span> &#123;</span><br><span class="line">  <span class="variable constant_">IS_REACTIVE</span> = <span class="string">&quot;__v_isReactive&quot;</span>,</span><br><span class="line">  <span class="variable constant_">IS_READONLY</span> = <span class="string">&quot;__v_isReadonly&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isReactive</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> value[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 触发get操作的逻辑</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createGetter</span>(<span class="params">isReadOnly = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> !isReadOnly;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 收集依赖</span></span><br><span class="line">    <span class="keyword">if</span> (!isReadOnly) &#123;</span><br><span class="line">      <span class="title function_">track</span>(target, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>expect(isReactive(original)).toBe(false);</code>会得到<code>undefined</code>是因为一个非响应式对象是触发不了<code>reactive</code>中的 get 操作的,所以需要把<code>undefined</code>转为布尔值;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isReactive</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !!value[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-isReadonly"><a href="#实现-isReadonly" class="headerlink" title="实现 isReadonly"></a>实现 isReadonly</h2><blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>isReadonly</code> 是一个函数，用于检查一个对象是否是只读的响应式对象。只读的响应式对象是通过 <code>readonly</code> 函数创建的，它们不允许直接修改其属性或索引。</p>
<p><code>isReadonly</code> 函数接受一个参数，即要检查的对象，并返回一个布尔值，表示该对象是否是只读的响应式对象。</p>
<p>使用 <code>isReadonly</code>，你可以在代码中检查一个对象是否被转换为只读的响应式对象。这在开发过程中是很有用的，特别是当你需要确认某个对象是否已经具备只读的响应式特性，或者用于调试和验证目的。</p>
<p>下面是一个使用 <code>isReadonly</code> 的简单示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; readonly, isReadonly &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myObject = <span class="title function_">readonly</span>(&#123; <span class="attr">name</span>: <span class="string">&quot;John&quot;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReadonly</span>(myObject)); <span class="comment">// 输出：true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isReadonly</span>(&#123; <span class="attr">name</span>: <span class="string">&quot;Jane&quot;</span> &#125;)); <span class="comment">// 输出：false，因为这个对象不是只读的响应式对象</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们通过 <code>readonly</code> 将 <code>myObject</code> 转换为只读的响应式对象，并使用 <code>isReadonly</code> 检查该对象是否是只读的响应式对象，结果返回 <code>true</code>。</p>
<p>需要注意的是，<code>isReadonly</code> 只能用于检查通过 Vue 提供的只读响应式 API（例如 <code>readonly</code>）转换的对象，而不能用于原生 JavaScript 对象。</p>
<p>总结一下，<code>isReadonly</code> 是 Vue 3 中的一个实用函数，用于检查一个对象是否是只读的响应式对象。它返回一个布尔值，表示该对象是否具备只读的响应式特性，这在开发过程中有助于验证和调试。</p>
<h3 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// not set</span></span><br><span class="line">  <span class="keyword">const</span> original = &#123; <span class="attr">foo</span>: <span class="number">1</span>, <span class="attr">bar</span>: &#123; <span class="attr">baz</span>: <span class="number">2</span> &#125; &#125;;</span><br><span class="line">  <span class="keyword">const</span> wrapped = <span class="title function_">readonly</span>(original);</span><br><span class="line">  <span class="title function_">expect</span>(wrapped).<span class="property">not</span>.<span class="title function_">toBe</span>(original);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isReadOnly</span>(wrapped)).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isReadOnly</span>(original)).<span class="title function_">toBe</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="title function_">expect</span>(wrapped.<span class="property">foo</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-4"><a href="#实现代码-4" class="headerlink" title="实现代码"></a>实现代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> enum <span class="title class_">ReactiveFlags</span> &#123;</span><br><span class="line">  <span class="variable constant_">IS_REACTIVE</span> = <span class="string">&quot;__v_isReactive&quot;</span>,</span><br><span class="line">  <span class="variable constant_">IS_READONLY</span> = <span class="string">&quot;__v_isReadonly&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isReadOnly</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !!value[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和 isReactive 很类似, 在触发 get 操作的时候加入 isReadOnly 的判断即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createGetter</span>(<span class="params">isReadOnly = <span class="literal">false</span>, shallow = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> !isReadOnly;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadOnly;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 收集依赖</span></span><br><span class="line">    <span class="keyword">if</span> (!isReadOnly) &#123;</span><br><span class="line">      <span class="title function_">track</span>(target, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="reactive-和-readonly-嵌套对象转换功能"><a href="#reactive-和-readonly-嵌套对象转换功能" class="headerlink" title="reactive 和 readonly 嵌套对象转换功能"></a>reactive 和 readonly 嵌套对象转换功能</h2><h3 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">test</span>(<span class="string">&quot;nested reactive&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> original = &#123;</span><br><span class="line">    <span class="attr">nested</span>: &#123;</span><br><span class="line">      <span class="attr">foo</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">array</span>: [&#123; <span class="attr">bar</span>: <span class="number">2</span> &#125;],</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> observed = <span class="title function_">reactive</span>(original);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isReactive</span>(observed.<span class="property">nested</span>)).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isReactive</span>(observed.<span class="property">array</span>)).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isReactive</span>(observed.<span class="property">array</span>[<span class="number">0</span>])).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-5"><a href="#实现代码-5" class="headerlink" title="实现代码"></a>实现代码</h3><p>在触发 get 操作的时候看一看<code>const res = Reflect.get(target, key);</code>这里的 res 是不是 Object, 如果是则<code>return reactive(res)</code>;<br>readonly 也是类似的;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createGetter</span>(<span class="params">isReadOnly = <span class="literal">false</span>, shallow = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> !isReadOnly;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadOnly;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(res)) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadOnly ? <span class="title function_">readonly</span>(res) : <span class="title function_">reactive</span>(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 收集依赖</span></span><br><span class="line">    <span class="keyword">if</span> (!isReadOnly) &#123;</span><br><span class="line">      <span class="title function_">track</span>(target, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断某个变量是否为 Object</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">isObject</span> = (<span class="params">target</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> target === <span class="string">&quot;object&quot;</span> &amp;&amp; target !== <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="实现-shallowReadonly-功能"><a href="#实现-shallowReadonly-功能" class="headerlink" title="实现 shallowReadonly 功能"></a>实现 shallowReadonly 功能</h2><p>就是对象表层是响应式对象 readonly, 深层的是普通的对象;</p>
<blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>shallowReadonly</code> 是一个 API，用于创建一个浅只读的响应式代理对象。与 <code>readonly</code> 和 <code>reactive</code> 不同，<code>shallowReadonly</code> 只会对对象的第一层属性进行只读代理，而不会递归地对嵌套对象进行代理。这样创建的代理对象是浅只读的，即代理对象本身只读，但它的属性如果是对象或数组等可变类型，其内部的属性仍然可以被修改。</p>
<p>使用 <code>shallowReadonly</code> 的情况主要是当我们需要将一个对象转换为只读对象，但又不希望对其进行深层次的递归代理时，可以使用这个 API。</p>
<p>下面是 <code>shallowReadonly</code> 的基本用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; shallowReadonly &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> originalObj = &#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">  <span class="attr">nestedObj</span>: &#123;</span><br><span class="line">    <span class="attr">nestedFoo</span>: <span class="string">&quot;nestedBar&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readonlyObj = <span class="title function_">shallowReadonly</span>(originalObj);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(readonlyObj.<span class="property">foo</span>); <span class="comment">// 输出: &quot;bar&quot;</span></span><br><span class="line">readonlyObj.<span class="property">foo</span> = <span class="string">&quot;new value&quot;</span>; <span class="comment">// 不会修改，因为readonlyObj是只读的</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(readonlyObj.<span class="property">nestedObj</span>.<span class="property">nestedFoo</span>); <span class="comment">// 输出: &quot;nestedBar&quot;</span></span><br><span class="line">readonlyObj.<span class="property">nestedObj</span>.<span class="property">nestedFoo</span> = <span class="string">&quot;new value&quot;</span>; <span class="comment">// 会修改，因为nestedObj是可变类型，不会进行深层代理</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(originalObj.<span class="property">nestedObj</span>.<span class="property">nestedFoo</span>); <span class="comment">// 输出: &quot;new value&quot;，原始对象被修改</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们使用 <code>shallowReadonly</code> 创建了一个只读的代理对象 <code>readonlyObj</code>。<code>readonlyObj</code> 是 <code>originalObj</code> 的只读代理，因此对 <code>readonlyObj</code> 的直接属性进行修改是不允许的，但如果 <code>readonlyObj</code> 的直接属性是一个可变类型（比如对象或数组），则其内部属性仍然可以被修改，因为 <code>shallowReadonly</code> 不会对嵌套对象进行深层代理。</p>
<p>需要注意的是，<code>shallowReadonly</code> 会将嵌套对象包装成响应式对象，但仅限于第一层，不会递归到更深层次。</p>
<p>总结：<code>shallowReadonly</code> 是 Vue 3 中的一个 API，用于创建一个浅只读的响应式代理对象。它只会对对象的第一层属性进行只读代理，不会对嵌套对象进行深层代理。代理对象本身是只读的，但其内部的属性如果是可变类型，仍然可以被修改。这个 API 适用于需要将对象转换为只读对象，但又不希望进行深层代理的场景。</p>
<h3 id="测试代码-6"><a href="#测试代码-6" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;shallowReadonly&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">test</span>(<span class="string">&quot;only first flat is reactive&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="title function_">shallowReadonly</span>(&#123; <span class="attr">n</span>: &#123; <span class="attr">foo</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line">    <span class="title function_">expect</span>(<span class="title function_">isReadOnly</span>(props)).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">expect</span>(<span class="title function_">isReadOnly</span>(props.<span class="property">n</span>)).<span class="title function_">toBe</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-6"><a href="#实现代码-6" class="headerlink" title="实现代码"></a>实现代码</h3><p>在 get 操作的时候, 如果是 shallow 类型, 则直接<code>return res</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createGetter</span>(<span class="params">isReadOnly = <span class="literal">false</span>, shallow = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> !isReadOnly;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadOnly;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shallow) &#123;</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(res)) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadOnly ? <span class="title function_">readonly</span>(res) : <span class="title function_">reactive</span>(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 收集依赖</span></span><br><span class="line">    <span class="keyword">if</span> (!isReadOnly) &#123;</span><br><span class="line">      <span class="title function_">track</span>(target, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-isProxy"><a href="#实现-isProxy" class="headerlink" title="实现 isProxy"></a>实现 isProxy</h2><blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>isProxy</code> 是一个用于检查对象是否为 Vue 3 响应式代理对象的函数。它用于判断一个对象是否被 Vue 3 的响应式系统转换成了代理对象，通常用于调试和开发目的。</p>
<p>在 Vue 3 中，当使用 <code>reactive</code> 或 <code>ref</code> 创建响应式对象时，Vue 3 内部会将这些对象转换成代理对象。代理对象可以追踪其属性的读取和修改操作，并在属性变化时触发相应的依赖更新。</p>
<p><code>isProxy</code> 函数的使用方法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, isProxy &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123; <span class="attr">foo</span>: <span class="string">&quot;bar&quot;</span> &#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isProxy</span>(obj)); <span class="comment">// 输出: true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> normalObj = &#123; <span class="attr">foo</span>: <span class="string">&quot;bar&quot;</span> &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isProxy</span>(normalObj)); <span class="comment">// 输出: false</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>在上面的例子中，我们先使用 <code>reactive</code> 创建了一个响应式对象 <code>obj</code>，然后使用 <code>isProxy</code> 函数判断 <code>obj</code> 是否为代理对象，因为 <code>obj</code> 是由 <code>reactive</code> 创建的，所以 <code>isProxy(obj)</code> 返回 <code>true</code>。</p>
</li>
<li><p>接着，我们创建了一个普通的 JavaScript 对象 <code>normalObj</code>，并使用 <code>isProxy</code> 函数判断 <code>normalObj</code> 是否为代理对象，由于 <code>normalObj</code> 并没有经过响应式转换，所以 <code>isProxy(normalObj)</code> 返回 <code>false</code>。</p>
</li>
</ul>
<p>需要注意的是，<code>isProxy</code> 函数只能检测由 Vue 3 的响应式系统转换的代理对象，对于其他类型的代理对象，它并不能识别。此外，<code>isProxy</code> 函数在生产环境中默认会被优化掉，所以在生产环境中调用 <code>isProxy</code> 总是会返回 <code>false</code>。</p>
<p>总结：<code>isProxy</code> 是 Vue 3 中的一个函数，用于判断一个对象是否为 Vue 3 响应式代理对象。它在调试和开发中有一定的用途，可以用于检查对象是否已经被 Vue 3 的响应式系统转换成了代理对象。但需要注意，在生产环境中调用 <code>isProxy</code> 总是会返回 <code>false</code>。</p>
<blockquote>
<p>实现</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isProxy</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">isReactive</span>(value) || <span class="title function_">isReadOnly</span>(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-ref-功能"><a href="#实现-ref-功能" class="headerlink" title="实现 ref 功能"></a>实现 ref 功能</h2><p><code>ref</code> 是 Vue 3 中的一个响应式 API，用于将普通的数据转换为响应式数据。在 Vue 2 中，我们使用 <code>data</code> 函数来定义响应式数据，而在 Vue 3 中，<code>ref</code> 提供了一种更加简洁的方式来创建响应式数据。</p>
<p>在 Vue 3 中，<code>ref</code> 是一个函数，它接收一个普通的 JavaScript 值作为参数，并返回一个包装后的响应式对象。这个包装后的对象在访问时会自动跟踪依赖，并在数据变化时触发响应式更新。要访问被 <code>ref</code> 包装的值，我们需要使用 <code>.value</code> 属性来获取。</p>
<p>下面是 <code>ref</code> 的基本用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个响应式的 ref</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(count.<span class="property">value</span>); <span class="comment">// 输出: 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改 ref 的值，会自动触发响应式更新</span></span><br><span class="line">count.<span class="property">value</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(count.<span class="property">value</span>); <span class="comment">// 输出: 1</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，当使用 <code>ref</code> 创建响应式数据时，Vue 3 内部会对原始值进行包装，但是在代码中仍然访问 <code>ref</code> 创建的变量时，我们直接使用 <code>.value</code> 来获取其值。这样做是为了确保在模板中使用 <code>ref</code> 创建的变量时，可以直接访问到实际的值，而不需要手动获取 <code>.value</code> 属性。</p>
<p>在模板中使用 <code>ref</code> 创建的响应式数据时，Vue 3 会自动解包。例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Count: &#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;increment&quot;</span>&gt;</span>Increment<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        count.<span class="property">value</span>++;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        count,</span></span><br><span class="line"><span class="language-javascript">        increment,</span></span><br><span class="line"><span class="language-javascript">      &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们在 <code>setup</code> 函数中使用 <code>ref</code> 创建了一个响应式的 <code>count</code> 变量，并且在模板中直接使用 <code>count</code>，而不需要使用 <code>count.value</code>，Vue 3 会自动进行解包。</p>
<p>需要注意的是，如果在 <code>setup</code> 函数之外的普通 JavaScript 代码中使用 <code>ref</code> 创建的变量，需要访问其值时要使用 <code>.value</code> 属性。</p>
<p>总结：<code>ref</code> 是 Vue 3 中用于创建响应式数据的 API，它可以将普通的 JavaScript 值转换为响应式数据，并且在访问和修改数据时自动触发响应式更新。在模板中使用 <code>ref</code> 创建的响应式数据时，Vue 3 会自动解包，直接使用变量名即可，而在其他代码中需要访问其值时需要使用 <code>.value</code> 属性。</p>
<h3 id="happy-path"><a href="#happy-path" class="headerlink" title="happy path"></a>happy path</h3><p>ref 和 reactive 的区别: ref 传入的都是单值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 true &#x27;abc&#x27;</span></span><br><span class="line"><span class="comment">// 如何知道被get or set</span></span><br><span class="line"><span class="comment">// 不能使用之前的proxy, 因为proxy针对的是一个对象</span></span><br><span class="line"><span class="comment">// 而这里传入的是单值</span></span><br><span class="line"><span class="comment">// 所以使用一个对象进行包裹</span></span><br><span class="line"><span class="comment">// &#123;&#125; -&gt; .value -&gt; get or set</span></span><br><span class="line"><span class="comment">// 这也是为什么我们的值类型需要ref进行包裹成为响应式数据</span></span><br></pre></td></tr></table></figure>

<h4 id="测试代码-7"><a href="#测试代码-7" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="title function_">ref</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="title function_">expect</span>(a.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="实现代码-7"><a href="#实现代码-7" class="headerlink" title="实现代码"></a>实现代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span> &#123;</span><br><span class="line">  private <span class="attr">_value</span>: any;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="should-be-reactive"><a href="#should-be-reactive" class="headerlink" title="should be reactive"></a>should be reactive</h3><h4 id="测试代码-8"><a href="#测试代码-8" class="headerlink" title="测试代码"></a>测试代码</h4><p>能够触发与收集依赖</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;should be reactive&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="title function_">ref</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">let</span> dummy;</span><br><span class="line">  <span class="keyword">let</span> calls = <span class="number">0</span>;</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    calls++;</span><br><span class="line">    dummy = a.<span class="property">value</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">expect</span>(calls).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  a.<span class="property">value</span> = <span class="number">2</span>;</span><br><span class="line">  <span class="title function_">expect</span>(calls).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="comment">// same value should not trigger</span></span><br><span class="line">  a.<span class="property">value</span> = <span class="number">2</span>;</span><br><span class="line">  <span class="title function_">expect</span>(calls).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="实现代码-8"><a href="#实现代码-8" class="headerlink" title="实现代码"></a>实现代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; hasChanged &#125; <span class="keyword">from</span> <span class="string">&quot;../shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isTracking, trackEffects, triggerEffects &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span> &#123;</span><br><span class="line">  private <span class="attr">_value</span>: any;</span><br><span class="line">  public dep;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = value;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="title function_">trackRefValue</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="comment">// 必须先修改了value的值, 才去通知</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// newValue === this._value ? return</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(newValue, <span class="variable language_">this</span>.<span class="property">_value</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = newValue;</span><br><span class="line">      <span class="title function_">triggerEffects</span>(<span class="variable language_">this</span>.<span class="property">dep</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trackRefValue</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTracking</span>()) &#123;</span><br><span class="line">    <span class="title function_">trackEffects</span>(ref.<span class="property">dep</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">hasChanged</span> = (<span class="params">val, newVal</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="title class_">Object</span>.<span class="title function_">is</span>(val, newVal);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isTracking</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> shouldTrack &amp;&amp; activeEffect !== <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trackEffects</span>(<span class="params">dep</span>) &#123;</span><br><span class="line">  <span class="comment">// 用 dep 来存放所有的 effect</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">  <span class="comment">// 这里是一个优化点</span></span><br><span class="line">  <span class="comment">// 先看看这个依赖是不是已经收集了，</span></span><br><span class="line">  <span class="comment">// 已经收集的话，那么就不需要在收集一次了</span></span><br><span class="line">  <span class="comment">// 可能会影响 code path change 的情况</span></span><br><span class="line">  <span class="comment">// 需要每次都 cleanupEffect</span></span><br><span class="line">  <span class="comment">// shouldTrack = !dep.has(activeEffect!);</span></span><br><span class="line">  <span class="keyword">if</span> (!dep.<span class="title function_">has</span>(activeEffect)) &#123;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">    (activeEffect <span class="keyword">as</span> any).<span class="property">deps</span>.<span class="title function_">push</span>(dep);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">triggerEffects</span>(<span class="params">dep</span>) &#123;</span><br><span class="line">  <span class="comment">// 执行收集到的所有的 effect 的 run 方法</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> dep) &#123;</span><br><span class="line">    <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">      <span class="comment">// scheduler 可以让用户自己选择调用的时机</span></span><br><span class="line">      <span class="comment">// 这样就可以灵活的控制调用了</span></span><br><span class="line">      <span class="comment">// 在 runtime-core 中，就是使用了 scheduler 实现了在 next ticker 中调用的逻辑</span></span><br><span class="line">      effect.<span class="title function_">scheduler</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      effect.<span class="title function_">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="should-make-nested-propertiers-reactive"><a href="#should-make-nested-propertiers-reactive" class="headerlink" title="should make nested propertiers reactive"></a>should make nested propertiers reactive</h3><h4 id="测试代码-9"><a href="#测试代码-9" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;should make nested propertiers reactive&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="title function_">ref</span>(&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">let</span> dummy;</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    dummy = a.<span class="property">value</span>.<span class="property">count</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  a.<span class="property">value</span>.<span class="property">count</span> = <span class="number">2</span>;</span><br><span class="line">  <span class="title function_">expect</span>(dummy).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="实现代码-9"><a href="#实现代码-9" class="headerlink" title="实现代码"></a>实现代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; hasChanged, isObject &#125; <span class="keyword">from</span> <span class="string">&quot;../shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isTracking, trackEffects, triggerEffects &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span> &#123;</span><br><span class="line">  private <span class="attr">_value</span>: any;</span><br><span class="line">  private <span class="attr">_rawValue</span>: any;</span><br><span class="line">  public dep;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_rawValue</span> = value;</span><br><span class="line">    <span class="comment">//看看value是否为对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="title function_">isObject</span>(value) ? <span class="title function_">reactive</span>(value) : value;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="title function_">trackRefValue</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="comment">// 必须先修改了value的值, 才去通知</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// newValue === this._value ? return</span></span><br><span class="line">    <span class="comment">//不能直接判断hasChanged(newValue, this._value)</span></span><br><span class="line">    <span class="comment">//因为value可能是一个proxy和一个普通对象进行比较</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(newValue, <span class="variable language_">this</span>.<span class="property">_rawValue</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// this._value = newValue;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rawValue</span> = newValue;</span><br><span class="line">      <span class="comment">//看看value是否为对象</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="title function_">isObject</span>(newValue) ? <span class="title function_">reactive</span>(newValue) : newValue;</span><br><span class="line">      <span class="title function_">triggerEffects</span>(<span class="variable language_">this</span>.<span class="property">dep</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trackRefValue</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTracking</span>()) &#123;</span><br><span class="line">    <span class="title function_">trackEffects</span>(ref.<span class="property">dep</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="重构代码"><a href="#重构代码" class="headerlink" title="重构代码"></a>重构代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span> &#123;</span><br><span class="line">  private <span class="attr">_value</span>: any;</span><br><span class="line">  private <span class="attr">_rawValue</span>: any;</span><br><span class="line">  public dep;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_rawValue</span> = value;</span><br><span class="line">    <span class="comment">//看看value是否为对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="title function_">convert</span>(value);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="title function_">trackRefValue</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="comment">// 必须先修改了value的值, 才去通知</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// newValue === this._value ? return</span></span><br><span class="line">    <span class="comment">//不能直接判断hasChanged(newValue, this._value)</span></span><br><span class="line">    <span class="comment">//因为value可能是一个proxy和一个普通对象进行比较</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(newValue, <span class="variable language_">this</span>.<span class="property">_rawValue</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// this._value = newValue;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rawValue</span> = newValue;</span><br><span class="line">      <span class="comment">//看看value是否为对象</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="title function_">convert</span>(newValue);</span><br><span class="line">      <span class="title function_">triggerEffects</span>(<span class="variable language_">this</span>.<span class="property">dep</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trackRefValue</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTracking</span>()) &#123;</span><br><span class="line">    <span class="title function_">trackEffects</span>(ref.<span class="property">dep</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">convert</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>  <span class="title function_">isObject</span>(value) ? <span class="title function_">reactive</span>(value) : value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-isRef"><a href="#实现-isRef" class="headerlink" title="实现 isRef"></a>实现 isRef</h2><blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>isRef</code> 是一个函数，用于检查一个值是否是 ref 对象。ref 对象是 Vue 3 响应式系统中的一个基本概念，用于将普通的数据变成响应式数据。</p>
<p><code>isRef</code> 函数接受一个参数，即要检查的值，并返回一个布尔值，表示该值是否是 ref 对象。</p>
<p>使用 <code>isRef</code>，你可以在代码中检查一个值是否被转换为 ref 对象。这在开发过程中是很有用的，特别是当你需要确认某个值是否已经具备 ref 的特性，或者用于调试和验证目的。</p>
<p>下面是一个使用 <code>isRef</code> 的简单示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, isRef &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myValue = <span class="title function_">ref</span>(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isRef</span>(myValue)); <span class="comment">// 输出：true</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isRef</span>(<span class="number">123</span>)); <span class="comment">// 输出：false，因为这个值不是 ref 对象</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们通过 <code>ref</code> 将 <code>myValue</code> 转换为 ref 对象，并使用 <code>isRef</code> 检查该值是否是 ref 对象，结果返回 <code>true</code>。</p>
<p>需要注意的是，<code>isRef</code> 只能用于检查通过 Vue 提供的 <code>ref</code> 函数转换的值，而不能用于普通的 JavaScript 值。</p>
<p>此外，如果你想要访问 ref 对象的值，需要使用 <code>.value</code> 属性。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myValue.<span class="property">value</span>); <span class="comment">// 输出：42</span></span><br></pre></td></tr></table></figure>

<p>总结一下，<code>isRef</code> 是 Vue 3 中的一个实用函数，用于检查一个值是否是 ref 对象。它返回一个布尔值，表示该值是否具备 ref 对象的特性，这在开发过程中有助于验证和调试。同时，记得如果要访问 ref 对象的值，需要使用 <code>.value</code> 属性。</p>
<h3 id="测试代码-10"><a href="#测试代码-10" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;isRef&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="title function_">ref</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">age</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isRef</span>(a)).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isRef</span>(<span class="number">1</span>)).<span class="title function_">toBe</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">isRef</span>(user)).<span class="title function_">toBe</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-10"><a href="#实现代码-10" class="headerlink" title="实现代码"></a>实现代码</h3><p>实现思路:<code>class RefImpl</code>给一个标识即可<code>public _v_is_Ref = true;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span> &#123;</span><br><span class="line">  private <span class="attr">_value</span>: any;</span><br><span class="line">  private <span class="attr">_rawValue</span>: any;</span><br><span class="line">  public dep;</span><br><span class="line">  public _v_is_Ref = <span class="literal">true</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_rawValue</span> = value;</span><br><span class="line">    <span class="comment">//看看value是否为对象</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="title function_">convert</span>(value);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="title function_">trackRefValue</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="comment">// 必须先修改了value的值, 才去通知</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// newValue === this._value ? return</span></span><br><span class="line">    <span class="comment">//不能直接判断hasChanged(newValue, this._value)</span></span><br><span class="line">    <span class="comment">//因为value可能是一个proxy和一个普通对象进行比较</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(newValue, <span class="variable language_">this</span>.<span class="property">_rawValue</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// this._value = newValue;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rawValue</span> = newValue;</span><br><span class="line">      <span class="comment">//看看value是否为对象</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="title function_">convert</span>(newValue);</span><br><span class="line">      <span class="title function_">triggerEffects</span>(<span class="variable language_">this</span>.<span class="property">dep</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trackRefValue</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTracking</span>()) &#123;</span><br><span class="line">    <span class="title function_">trackEffects</span>(ref.<span class="property">dep</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">convert</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>  <span class="title function_">isObject</span>(value) ? <span class="title function_">reactive</span>(value) : value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isRef</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !!ref.<span class="property">_v_is_Ref</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-unRef"><a href="#实现-unRef" class="headerlink" title="实现 unRef"></a>实现 unRef</h2><p>在 Vue 3 中，<code>unref</code> 是一个实用函数，用于获取 ref 对象的原始值。ref 对象是 Vue 3 响应式系统中的一个基本概念，用于将普通的数据变成响应式数据。当你需要访问 ref 对象内部的值时，通常需要使用 <code>unref</code> 来获取该值。</p>
<p><code>unref</code> 函数接受一个参数，即要获取原始值的 ref 对象，然后返回该 ref 对象所包裹的原始值。</p>
<p>下面是一个使用 <code>unref</code> 的简单示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, unref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myValue = <span class="title function_">ref</span>(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">unref</span>(myValue)); <span class="comment">// 输出：42</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们通过 <code>ref</code> 创建了一个 ref 对象 <code>myValue</code>，然后使用 <code>unref</code> 函数获取其原始值，并将其打印到控制台。</p>
<p>需要注意的是，如果传递给 <code>unref</code> 的参数不是 ref 对象，它会直接返回传入的值本身，而不做任何处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">unref</span>(<span class="number">123</span>)); <span class="comment">// 输出：123，因为参数不是 ref 对象</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">unref</span>(<span class="string">&quot;hello&quot;</span>)); <span class="comment">// 输出：&#x27;hello&#x27;，因为参数不是 ref 对象</span></span><br></pre></td></tr></table></figure>

<p><code>unref</code> 在使用时非常灵活，可以用于处理不确定是否是 ref 对象的值。它允许你在需要获取 ref 对象的原始值时使用，同时也可以安全地处理非 ref 对象的值，而不会引发错误。</p>
<p>总结一下，<code>unref</code> 是 Vue 3 中的一个实用函数，用于获取 ref 对象的原始值。它接受一个参数，如果参数是 ref 对象，则返回 ref 对象所包裹的原始值，否则直接返回传入的值本身。这使得在处理 ref 对象和普通值时更加灵活和方便。</p>
<h3 id="测试代码-11"><a href="#测试代码-11" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;unRef&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="title function_">ref</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">age</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">unRef</span>(a)).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">unRef</span>(<span class="number">1</span>)).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-11"><a href="#实现代码-11" class="headerlink" title="实现代码"></a>实现代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isRef</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !!ref.<span class="property">_v_is_Ref</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">unRef</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">isRef</span>(ref) ? ref.<span class="property">value</span> : ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-proxyRefs"><a href="#实现-proxyRefs" class="headerlink" title="实现 proxyRefs"></a>实现 proxyRefs</h2><blockquote>
<p>介绍</p>
</blockquote>
<p>setUp 中访问对象属性值需要使用.value, 而 template 中调用了 proxyRefs, 所以可以直接使用属性值, 而不需要.value</p>
<p>在 Vue 3 中，<code>proxyRefs</code> 是一个实用函数，用于将一个响应式对象转换为普通的 JavaScript 对象。它可以用于在模板之外或在纯 JavaScript 环境中访问响应式对象的原始值，以及避免模板中 <code>ref</code> 和 <code>reactive</code> API 的副作用。</p>
<p>在 Vue 3 中，模板中使用的数据和状态通常都是通过 <code>ref</code> 和 <code>reactive</code> 创建的响应式对象。这些响应式对象是为了在模板中实现数据绑定和响应式更新。然而，在某些场景下，我们可能需要在纯 JavaScript 代码中处理这些响应式对象的原始值，这时就可以使用 <code>proxyRefs</code>。</p>
<p><code>proxyRefs</code> 函数接受一个参数，即要转换的响应式对象，然后返回一个普通的 JavaScript 对象，其中包含了响应式对象的原始值，但不再具有响应式特性。</p>
<p>下面是一个使用 <code>proxyRefs</code> 的简单示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, reactive, proxyRefs &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myValue = <span class="title function_">ref</span>(<span class="number">42</span>);</span><br><span class="line"><span class="keyword">const</span> myObject = <span class="title function_">reactive</span>(&#123; <span class="attr">name</span>: <span class="string">&quot;John&quot;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxyValue = <span class="title function_">proxyRefs</span>(&#123; myValue, myObject &#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(proxyValue.<span class="property">myValue</span>); <span class="comment">// 输出：42</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(proxyValue.<span class="property">myObject</span>); <span class="comment">// 输出：&#123; name: &#x27;John&#x27;, age: 30 &#125;</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们创建了两个响应式对象 <code>myValue</code> 和 <code>myObject</code>，然后使用 <code>proxyRefs</code> 将它们转换为普通的 JavaScript 对象 <code>proxyValue</code>。现在，<code>proxyValue</code> 包含了 <code>myValue</code> 和 <code>myObject</code> 的原始值，但它们不再是响应式的。</p>
<p>需要注意的是，<code>proxyRefs</code> 只能用于转换通过 Vue 提供的响应式 API（例如 <code>ref</code> 和 <code>reactive</code>）创建的响应式对象，而不能用于原生 JavaScript 对象。</p>
<p>使用 <code>proxyRefs</code> 可以帮助我们在需要访问响应式对象的原始值时，在不引入副作用的情况下将其转换为普通的 JavaScript 对象，从而更加灵活地处理数据。</p>
<p>总结一下，<code>proxyRefs</code> 是 Vue 3 中的一个实用函数，用于将响应式对象转换为普通的 JavaScript 对象。它接受一个参数，返回一个不再具有响应式特性的普通对象，其中包含了响应式对象的原始值。这在处理响应式对象时提供了更多的灵活性和控制权。</p>
<h3 id="测试代码-get"><a href="#测试代码-get" class="headerlink" title="测试代码 get"></a>测试代码 get</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;proxyRefs&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">age</span>: <span class="title function_">ref</span>(<span class="number">10</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;hx&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> proxyUser = <span class="title function_">proxyRefs</span>(user);</span><br><span class="line">  <span class="title function_">expect</span>(user.<span class="property">age</span>.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="title function_">expect</span>(proxyUser.<span class="property">age</span>).<span class="title function_">toBe</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="title function_">expect</span>(proxyUser.<span class="property">name</span>).<span class="title function_">toBe</span>(<span class="string">&quot;hx&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-get"><a href="#实现代码-get" class="headerlink" title="实现代码 get"></a>实现代码 get</h3><p>思路:<br>如果是 ref 类型就返回(修改).value</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">unRef</span>(<span class="params">ref</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">isRef</span>(ref) ? ref.<span class="property">value</span> : ref;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">proxyRefs</span>(<span class="params">objectWithRefs</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(objectWithRefs, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">unRef</span>(<span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key));</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试代码-set"><a href="#测试代码-set" class="headerlink" title="测试代码 set"></a>测试代码 set</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;proxyRefs&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">age</span>: <span class="title function_">ref</span>(<span class="number">10</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;hx&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// get逻辑</span></span><br><span class="line">  <span class="keyword">const</span> proxyUser = <span class="title function_">proxyRefs</span>(user);</span><br><span class="line">  <span class="title function_">expect</span>(user.<span class="property">age</span>.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="title function_">expect</span>(proxyUser.<span class="property">age</span>).<span class="title function_">toBe</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="title function_">expect</span>(proxyUser.<span class="property">name</span>).<span class="title function_">toBe</span>(<span class="string">&quot;hx&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set逻辑</span></span><br><span class="line">  <span class="comment">// 赋值非ref类型</span></span><br><span class="line">  proxyUser.<span class="property">age</span> = <span class="number">20</span>;</span><br><span class="line">  <span class="title function_">expect</span>(proxyUser.<span class="property">age</span>).<span class="title function_">toBe</span>(<span class="number">20</span>);</span><br><span class="line">  <span class="title function_">expect</span>(user.<span class="property">age</span>.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">20</span>);</span><br><span class="line">  <span class="comment">// 赋值ref类型 直接替换</span></span><br><span class="line">  proxyUser.<span class="property">age</span> = <span class="number">10</span>;</span><br><span class="line">  <span class="title function_">expect</span>(proxyUser.<span class="property">age</span>).<span class="title function_">toBe</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="title function_">expect</span>(user.<span class="property">age</span>.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">10</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-set"><a href="#实现代码-set" class="headerlink" title="实现代码 set"></a>实现代码 set</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">proxyRefs</span>(<span class="params">objectWithRefs</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(objectWithRefs, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">unRef</span>(<span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, newValue</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isRef</span>(target[key]) &amp;&amp; !<span class="title function_">isRef</span>(newValue)) &#123;</span><br><span class="line">        <span class="keyword">return</span> (target[key].<span class="property">value</span> = newValue);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, newValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-computed"><a href="#实现-computed" class="headerlink" title="实现 computed"></a>实现 computed</h2><blockquote>
<p>介绍</p>
</blockquote>
<p>在 Vue 3 中，<code>computed</code> 是一个用于计算属性的函数。计算属性是一种依赖于其他响应式数据的属性，它的值是根据计算逻辑动态得出的，并且会在依赖的数据发生变化时自动更新。</p>
<p>在 Vue 2 中，计算属性是通过选项 API 来定义的，而在 Vue 3 中，计算属性可以通过 <code>computed</code> 函数来定义，以更加简洁和灵活的方式创建。</p>
<p><code>computed</code> 函数接受两个参数：一个 getter 函数和一个可选的 setter 函数。getter 函数用于计算属性的值，它返回计算得出的结果；setter 函数用于处理计算属性被赋值时的行为（可选）。</p>
<p>下面是一个使用 <code>computed</code> 的简单示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, computed &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> firstName = <span class="title function_">ref</span>(<span class="string">&quot;John&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> lastName = <span class="title function_">ref</span>(<span class="string">&quot;Doe&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fullName = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;firstName.value&#125;</span> <span class="subst">$&#123;lastName.value&#125;</span>`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fullName.<span class="property">value</span>); <span class="comment">// 输出：&#x27;John Doe&#x27;</span></span><br><span class="line"></span><br><span class="line">firstName.<span class="property">value</span> = <span class="string">&quot;Jane&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fullName.<span class="property">value</span>); <span class="comment">// 输出：&#x27;Jane Doe&#x27;，计算属性会自动更新</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，我们通过 <code>ref</code> 创建了两个响应式对象 <code>firstName</code> 和 <code>lastName</code>，然后使用 <code>computed</code> 定义了一个计算属性 <code>fullName</code>，它通过 getter 函数计算得出完整的姓名。当 <code>firstName</code> 或 <code>lastName</code> 发生变化时，<code>fullName</code> 会自动更新。</p>
<p>需要注意的是，计算属性的值是只读的，你不能直接给计算属性赋值。如果你想要实现双向绑定，你可以使用 <code>ref</code> 或 <code>reactive</code> 创建一个普通的响应式对象，并在 <code>computed</code> 的 setter 函数中处理赋值逻辑。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, computed &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fullName = <span class="title function_">ref</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> firstName = <span class="title function_">ref</span>(<span class="string">&quot;John&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> lastName = <span class="title function_">ref</span>(<span class="string">&quot;Doe&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> computedFullName = <span class="title function_">computed</span>(&#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="function">() =&gt;</span> fullName.<span class="property">value</span>,</span><br><span class="line">  <span class="attr">set</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> (fullName.<span class="property">value</span> = value),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">computedFullName.<span class="property">value</span> = <span class="string">&quot;Jane Smith&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(firstName.<span class="property">value</span>); <span class="comment">// 输出：&#x27;Jane&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(lastName.<span class="property">value</span>); <span class="comment">// 输出：&#x27;Smith&#x27;</span></span><br></pre></td></tr></table></figure>

<p>总结一下，<code>computed</code> 是 Vue 3 中的一个实用函数，用于定义计算属性。计算属性依赖于其他响应式数据，并根据计算逻辑动态得出结果。<code>computed</code> 函数接受一个 getter 函数和一个可选的 setter 函数，用于定义计算属性的计算和赋值行为。计算属性的值是只读的，会在依赖的数据发生变化时自动更新，因此它是处理派生状态的理想方式。</p>
<h3 id="测试代码-简单"><a href="#测试代码-简单" class="headerlink" title="测试代码-简单"></a>测试代码-简单</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; computed &#125; <span class="keyword">from</span> <span class="string">&quot;../computed&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;../reactive&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;computed&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;happy path&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">      <span class="attr">age</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> age = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> user.<span class="property">age</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title function_">expect</span>(age.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-简单"><a href="#实现代码-简单" class="headerlink" title="实现代码-简单"></a>实现代码-简单</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ComputedRefImple</span> &#123;</span><br><span class="line">  private <span class="attr">_getter</span>: any;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">getter</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_getter</span> = getter;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_getter</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComputedRefImple</span>(getter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试代码-12"><a href="#测试代码-12" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;should compute lazily&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> value = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> getter = jest.<span class="title function_">fn</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> value.<span class="property">foo</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> cValue = <span class="title function_">computed</span>(getter);</span><br><span class="line">  <span class="comment">// lazy</span></span><br><span class="line">  <span class="comment">// 没有访问cValue.foo的话getter不会被调用</span></span><br><span class="line">  <span class="title function_">expect</span>(getter).<span class="property">not</span>.<span class="title function_">toHaveBeenCalled</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">expect</span>(cValue.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="title function_">expect</span>(getter).<span class="title function_">toHaveBeenCalledTimes</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// should not compute again</span></span><br><span class="line">  <span class="comment">// 再次访问cValue.foo的话getter也只会被调用一次</span></span><br><span class="line">  cValue.<span class="property">value</span>;</span><br><span class="line">  <span class="title function_">expect</span>(getter).<span class="title function_">toHaveBeenCalledTimes</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// should not compute until needed</span></span><br><span class="line">  value.<span class="property">foo</span> = <span class="number">2</span>; <span class="comment">//trigger</span></span><br><span class="line">  <span class="title function_">expect</span>(getter).<span class="title function_">toHaveBeenCalledTimes</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// // now it should compute</span></span><br><span class="line">  <span class="title function_">expect</span>(cValue.<span class="property">value</span>).<span class="title function_">toBe</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="title function_">expect</span>(getter).<span class="title function_">toHaveBeenCalledTimes</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// // should not compute again</span></span><br><span class="line">  cValue.<span class="property">value</span>;</span><br><span class="line">  <span class="title function_">expect</span>(getter).<span class="title function_">toHaveBeenCalledTimes</span>(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="实现代码-12"><a href="#实现代码-12" class="headerlink" title="实现代码"></a>实现代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReactiveEffect</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ComputedRefImple</span> &#123;</span><br><span class="line">  private <span class="attr">_getter</span>: any;</span><br><span class="line">  private <span class="attr">_dirty</span>: boolean = <span class="literal">true</span>;</span><br><span class="line">  private <span class="attr">_value</span>: any;</span><br><span class="line">  private <span class="attr">_effect</span>: any;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">getter</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_getter</span> = getter;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(getter, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">_dirty</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_dirty</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="comment">// 当依赖的响应式对象的值发生改变时</span></span><br><span class="line">    <span class="comment">// dirty -&gt; true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_dirty</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_dirty</span> = <span class="literal">false</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="variable language_">this</span>.<span class="property">_effect</span>.<span class="title function_">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComputedRefImple</span>(getter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="runtime-core"><a href="#runtime-core" class="headerlink" title="runtime-core"></a>runtime-core</h1><p>Vue.js 3 的源码中有一个重要的模块叫做 <code>runtime-core</code>，它是 Vue 3 运行时的核心部分。<code>runtime-core</code> 负责处理组件实例的创建、更新、渲染以及与响应式系统的交互等关键功能。下面我们使用中文详细介绍 <code>runtime-core</code> 的主要内容：</p>
<ol>
<li><p>组件实例创建与挂载：<br><code>runtime-core</code> 中的 <code>createComponentInstance</code> 函数用于创建组件实例。组件实例是组件的一个具体运行时表现，其中包含组件的状态、属性、生命周期钩子等。当我们使用 <code>createApp</code> 创建一个 Vue 应用时，它会通过 <code>createComponentInstance</code> 创建根组件实例，并且调用 <code>setup</code> 函数来初始化组件状态。</p>
</li>
<li><p>组件实例的更新与渲染：<br><code>runtime-core</code> 中的 <code>updateComponent</code> 函数用于处理组件实例的更新和渲染。当组件实例的状态发生变化时，<code>updateComponent</code> 会负责更新虚拟 DOM 树并触发视图的重新渲染。Vue 3 中引入了新的渲染器 <code>renderer</code>，它负责将虚拟 DOM 转换为实际的 DOM，并执行 DOM 更新操作。</p>
</li>
<li><p>响应式系统的集成：<br><code>runtime-core</code> 和 <code>@vue/reactivity</code> 包紧密集成，以支持 Vue 3 的响应式系统。组件实例中的 <code>setupState</code> 和 <code>props</code> 都是响应式的对象，当其中的属性发生变化时，会触发组件的重新渲染。<code>runtime-core</code> 会跟踪组件实例的依赖关系，并在更新时调用 <code>effect</code> 函数进行更新。</p>
</li>
<li><p>生命周期的实现：<br><code>runtime-core</code> 中还包含 Vue 3 组件的生命周期相关代码。比如，<code>beforeCreate</code>、<code>created</code>、<code>beforeMount</code>、<code>mounted</code> 等生命周期钩子都会在合适的时机被调用，以便开发者在组件生命周期中执行相应的逻辑。</p>
</li>
<li><p>虚拟 DOM 的处理：<br>Vue 3 使用了虚拟 DOM 来高效地更新实际 DOM。<code>runtime-core</code> 中有关虚拟 DOM 的处理代码负责创建虚拟 DOM、对比新旧虚拟 DOM 的差异，并将变化应用到实际 DOM 上。</p>
</li>
<li><p>事件处理：<br><code>runtime-core</code> 处理了组件中的事件绑定和事件触发。它会监听 DOM 事件，并根据组件实例的配置调用相应的事件处理函数。</p>
</li>
<li><p>异步更新与性能优化：<br>Vue 3 引入了异步更新策略，可以将一些更新合并为一个异步的更新批次，以提高性能。<code>runtime-core</code> 中有关更新的代码会利用异步更新策略，减少不必要的重复渲染。</p>
</li>
</ol>
<p>总结：<code>runtime-core</code> 是 Vue 3 运行时的核心部分，负责处理组件实例的创建、更新、渲染以及与响应式系统的交互。它通过虚拟 DOM 和异步更新等优化策略，提供了高效的组件渲染和更新机制，为 Vue 3 提供了强大的运行时支持。</p>
<h2 id="实现初始化-component-主流程"><a href="#实现初始化-component-主流程" class="headerlink" title="实现初始化 component 主流程"></a>实现初始化 component 主流程</h2><h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><ol>
<li>先调用 render 函数<code>render(vnode, rootContainer)</code>;</li>
<li>在 render 中调用 patch 函数<code>patch()</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line">  <span class="comment">// patch 方便递归处理</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">patch</span>(vnode, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h3><p>使用 patch 判断类型<code>check type of vnode</code><br><code>processComponent</code> or <code>processElement</code><br>是 component 类型还是 element 类型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line">  <span class="comment">// 处理组件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//   判断是不是element</span></span><br><span class="line">  <span class="title function_">processComponent</span>(vnode, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="processComponent"><a href="#processComponent" class="headerlink" title="processComponent"></a>processComponent</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processComponent</span>(<span class="params">vnode: any, container: any</span>) &#123;</span><br><span class="line">  <span class="title function_">mountComponent</span>(vnode, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="mountComponent"><a href="#mountComponent" class="headerlink" title="mountComponent"></a>mountComponent</h5><h6 id="抽象出一个-component-instance"><a href="#抽象出一个-component-instance" class="headerlink" title="抽象出一个 component instance"></a>抽象出一个 component instance</h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountComponent</span>(<span class="params">vnode: any, container: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="title function_">createComponentInstance</span>(vnode);</span><br><span class="line">  <span class="title function_">setupComponent</span>(instance);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setupRenderEffect</span>(instance, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="setupComponent-instance"><a href="#setupComponent-instance" class="headerlink" title="setupComponent(instance);"></a><code>setupComponent(instance);</code></h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setupComponent</span>(<span class="params">instance</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">  <span class="comment">// initProps()</span></span><br><span class="line">  <span class="comment">// initSlots()</span></span><br><span class="line">  <span class="title function_">setupStatefulComponent</span>(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>initProps<br>TODO</li>
<li>initSlots<br>TODO</li>
<li>setupStatefulComponent</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// function object</span></span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">setup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">handleSetupResult</span>(instance, setupResult);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>handleSetupResult</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleSetupResult</span>(<span class="params">instance, setupResult: any</span>) &#123;</span><br><span class="line">  <span class="comment">// function object</span></span><br><span class="line">  <span class="comment">// TODO funtion</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> setupResult === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">    instance.<span class="property">setupResult</span> = setupResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">finishComponentSetup</span>(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>finishComponentSetup</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">finishComponentSetup</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Component</span>.<span class="property">render</span>) &#123;</span><br><span class="line">    instance.<span class="property">render</span> = <span class="title class_">Component</span>.<span class="property">render</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="setupRenderEffect-instance-container"><a href="#setupRenderEffect-instance-container" class="headerlink" title="setupRenderEffect(instance, container);"></a><code>setupRenderEffect(instance, container);</code></h6><p>setupComponent 完成之后会调用 render 函数, 如果是一个组件的话继续拆解, 如果是一个元素就渲染出来</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">rootComponent</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="title function_">mount</span>(<span class="params">rootContainer</span>) &#123;</span><br><span class="line">      <span class="comment">// 先vnode</span></span><br><span class="line">      <span class="comment">// component -&gt; vnode</span></span><br><span class="line">      <span class="comment">// 所有的逻辑操作都基于vnode进行</span></span><br><span class="line">      <span class="keyword">const</span> vnode = <span class="title function_">createVNode</span>(rootComponent);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">render</span>(vnode, rootContainer);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="updateComponent"><a href="#updateComponent" class="headerlink" title="updateComponent"></a>updateComponent</h5><h4 id="processElement"><a href="#processElement" class="headerlink" title="processElement"></a>processElement</h4><h2 id="使用-rollup-打包库"><a href="#使用-rollup-打包库" class="headerlink" title="使用 rollup 打包库"></a>使用 rollup 打包库</h2><p>rollup 一般用于库的打包, 而 webpack 一般用于应用项目打包</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add rollup --dev</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ol>
<li>新建 rollup.config.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typescript <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-typescript&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;./src/index.ts&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: [</span><br><span class="line">    <span class="comment">//打包出多种模块规范</span></span><br><span class="line">    <span class="comment">// 1. cjs</span></span><br><span class="line">    <span class="comment">// 2. esm</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">format</span>: <span class="string">&quot;cjs&quot;</span>,</span><br><span class="line">      <span class="attr">file</span>: <span class="string">&quot;lib/mini-vue.cjs.js&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">format</span>: <span class="string">&quot;esm&quot;</span>,</span><br><span class="line">      <span class="attr">file</span>: <span class="string">&quot;lib/mini-vue.mjs.js&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// rollup不认识ts, 需要使用一些插件进行编译</span></span><br><span class="line">  <span class="comment">// yarn add @rollup/plugin-typescript --dev</span></span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">typescript</span>()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>新建 mini-vue 出口文件 index.ts</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mini-vue 出口</span></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;./runtime-core&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime-core</span></span><br><span class="line"><span class="keyword">export</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&quot;./createApp&quot;</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置<code>package.json</code>文件<br>-c 代表指定配置文件<br>加入<code>  &quot;type&quot;: &quot;module&quot;,</code>不然打包的时候会报错</li>
</ol>
<p><code>import typescript from &quot;@rollup/plugin-typescript&quot;; ^^^^^^ SyntaxError: Cannot use import statement outside a module</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jest&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rollup -c rollup.config.js&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>新建 h 函数<br>h 就是调用了 createVNode 函数, 多封装了一层, 给用户使用</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createVNode &#125; <span class="keyword">from</span> <span class="string">&quot;./vnode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">type, props?, children?</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createVNode</span>(type, props, children);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现初始化-element-主流程"><a href="#实现初始化-element-主流程" class="headerlink" title="实现初始化 element 主流程"></a>实现初始化 element 主流程</h2><h2 id="实现组件代理对象"><a href="#实现组件代理对象" class="headerlink" title="实现组件代理对象"></a>实现组件代理对象</h2><p>可以在写业务代码的时候通过 this.$data, this.$el 等拿到想要的值<br>实现思路:</p>
<h3 id="从-setupState-中取值"><a href="#从-setupState-中取值" class="headerlink" title="从 setupState 中取值"></a>从 setupState 中取值</h3><ol>
<li>在组件初始化的时候创建一个代理对象</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="comment">// 从setupState中获取值</span></span><br><span class="line">        <span class="keyword">const</span> &#123; setupState &#125; = instance;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> setupState) &#123;</span><br><span class="line">          <span class="keyword">return</span> setupState[key];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createComponentInstance</span>(<span class="params">vnode</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> component = &#123;</span><br><span class="line">    vnode,</span><br><span class="line">    <span class="attr">type</span>: vnode.<span class="property">type</span>,</span><br><span class="line">    <span class="attr">setupState</span>: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> component;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在调用 render 的时候, 将之前创建好的代理对象绑定到 render 的 this 上</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupRenderEffect</span>(<span class="params">instance: any, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; proxy &#125; = instance;</span><br><span class="line">  <span class="keyword">const</span> subTree = instance.<span class="property">render</span>.<span class="title function_">call</span>(proxy);</span><br><span class="line">  <span class="comment">//vnode-&gt;patch</span></span><br><span class="line">  <span class="comment">// vnode -&gt; element -&gt; mountElement</span></span><br><span class="line">  <span class="title function_">patch</span>(subTree, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="this-el-中取值"><a href="#this-el-中取值" class="headerlink" title="this.$el 中取值"></a>this.$el 中取值</h3><p>this.$el 就是返回组件的根节点</p>
<ol>
<li>在 mountElement 先保存</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountElement</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> el = (vnode.<span class="property">el</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(vnode.<span class="property">type</span>));</span><br><span class="line">  <span class="keyword">const</span> &#123; children &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    el.<span class="property">textContent</span> = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(children)) &#123;</span><br><span class="line">    <span class="title function_">mountChildren</span>(vnode, el);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; props &#125; = vnode;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">const</span> val = props[key];</span><br><span class="line">    el.<span class="title function_">setAttribute</span>(key, val);</span><br><span class="line">  &#125;</span><br><span class="line">  container.<span class="title function_">append</span>(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<!--  -->

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupRenderEffect</span>(<span class="params">instance: any, vnode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; proxy &#125; = instance;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(proxy, <span class="string">&quot;proxy&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> subTree = instance.<span class="property">render</span>.<span class="title function_">call</span>(proxy);</span><br><span class="line">  <span class="comment">//vnode-&gt;patch</span></span><br><span class="line">  <span class="comment">// vnode -&gt; element -&gt; mountElement</span></span><br><span class="line">  <span class="title function_">patch</span>(subTree, container);</span><br><span class="line"></span><br><span class="line">  vnode.<span class="property">el</span> = subTree.<span class="property">el</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createVNode</span>(<span class="params">type, props?, children?</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">    type,</span><br><span class="line">    props,</span><br><span class="line">    children,</span><br><span class="line">    <span class="attr">el</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> vnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line"> <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line"> instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(</span><br><span class="line">   &#123;&#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">       <span class="comment">// 从setupState中获取值</span></span><br><span class="line">       <span class="keyword">const</span> &#123; setupState &#125; = instance;</span><br><span class="line">       <span class="keyword">if</span> (key <span class="keyword">in</span> setupState) &#123;</span><br><span class="line">         <span class="keyword">return</span> setupState[key];</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(key === <span class="string">&#x27;$el&#x27;</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> instance.<span class="property">vnode</span>.<span class="property">el</span>;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">   &#125;</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<h3 id="this-el-代码重构"><a href="#this-el-代码重构" class="headerlink" title="this.$el 代码重构"></a>this.$el 代码重构</h3><p>instance 有许多属性($data, $props, $el 等), 所有可以抽离出来</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123; <span class="attr">_</span>: instance &#125;, <span class="title class_">PublicInstanceProxyHandlers</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// function object</span></span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">setup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">handleSetupResult</span>(instance, setupResult);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> publicPropertiesMap = &#123;</span><br><span class="line">  <span class="attr">$el</span>: <span class="function">(<span class="params">i</span>) =&gt;</span> i.<span class="property">vnode</span>.<span class="property">el</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">PublicInstanceProxyHandlers</span> = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">&#123; _: instance &#125;, key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; setupState &#125; = instance;</span><br><span class="line">    <span class="keyword">if</span> (key <span class="keyword">in</span> setupState) &#123;</span><br><span class="line">      <span class="keyword">return</span> setupState[key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if (key === &quot;$el&quot;) &#123;</span></span><br><span class="line">    <span class="comment">//   return instance.vnode.el;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">const</span> publicGetter = publicPropertiesMap[key];</span><br><span class="line">    <span class="keyword">if</span> (publicGetter) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">publicGetter</span>(instance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="实现-shapeFlags"><a href="#实现-shapeFlags" class="headerlink" title="实现 shapeFlags"></a>实现 shapeFlags</h2><p>shapeFlags 描述了虚拟节点的一些类型</p>
<p>通过位运算的方式进行处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> enum  <span class="title class_">ShapeFlags</span>  &#123;</span><br><span class="line">    <span class="variable constant_">ELEMENT</span> = <span class="number">1</span>, <span class="comment">//0001</span></span><br><span class="line">    <span class="variable constant_">STATEFUL_COMPONENT</span> = <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="comment">//0010</span></span><br><span class="line">    <span class="variable constant_">TEXT_CHILDREN</span> = <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="comment">//0100</span></span><br><span class="line">    <span class="variable constant_">ARRAY_CHILDREN</span> = <span class="number">1</span> &lt;&lt; <span class="number">3</span>, <span class="comment">//1000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ShapeFlags</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./ShapeFlags&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createVNode</span>(<span class="params">type, props?, children?</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">    type,</span><br><span class="line">    props,</span><br><span class="line">    children,</span><br><span class="line">    <span class="attr">shapeFlag</span>: <span class="title function_">getShapeFlag</span>(type),</span><br><span class="line">    <span class="attr">el</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// children</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    vnode.<span class="property">shapeFlag</span> |= <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(children)) &#123;</span><br><span class="line">    vnode.<span class="property">shapeFlag</span> |= <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vnode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getShapeFlag</span>(<span class="params">type</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> type === <span class="string">&quot;string&quot;</span></span><br><span class="line">    ? <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span></span><br><span class="line">    : <span class="title class_">ShapeFlags</span>.<span class="property">STATEFUL_COMPONENT</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现注册事件功能"><a href="#实现注册事件功能" class="headerlink" title="实现注册事件功能"></a>实现注册事件功能</h2><p>onClick, onInput 等事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountElement</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> el = (vnode.<span class="property">el</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(vnode.<span class="property">type</span>));</span><br><span class="line">  <span class="keyword">const</span> &#123; children, shapeFlag &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">    el.<span class="property">textContent</span> = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">    <span class="title function_">mountChildren</span>(vnode, el);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; props &#125; = vnode;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">const</span> val = props[key];</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">isOn</span> = (<span class="params">key: string</span>) =&gt; <span class="regexp">/^on[A-Z]/</span>.<span class="title function_">test</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isOn</span>(key)) &#123;</span><br><span class="line">      <span class="keyword">const</span> event = key.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">toLocaleLowerCase</span>();</span><br><span class="line">      el.<span class="title function_">addEventListener</span>(event, val);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      el.<span class="title function_">setAttribute</span>(key, val);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  container.<span class="title function_">append</span>(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现组件-props-功能"><a href="#实现组件-props-功能" class="headerlink" title="实现组件 props 功能"></a>实现组件 props 功能</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&quot;../../lib/mini-vue.esm.js&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Foo</span> = &#123;</span><br><span class="line">  <span class="comment">// 1. 通过setup传值</span></span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="comment">// 2. 可以使用this.count取值</span></span><br><span class="line">    <span class="comment">// props.count</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(props);</span><br><span class="line">    <span class="comment">// 3. props是readonly</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, <span class="string">&quot;foo: &quot;</span> + <span class="variable language_">this</span>.<span class="property">count</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&quot;../../lib/mini-vue.esm.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Foo</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./Foo.js&quot;</span>;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">self</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">App</span> = &#123;</span><br><span class="line">  <span class="comment">// ui</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">self</span> = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(</span><br><span class="line">      <span class="string">&quot;div&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">        <span class="attr">class</span>: [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;box&quot;</span>],</span><br><span class="line">        <span class="attr">onClick</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">alert</span>(<span class="number">666</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// setupState</span></span><br><span class="line">      <span class="comment">// this.$el</span></span><br><span class="line">      <span class="comment">// 这里的this.msg是调用setup后return的对象中的msg</span></span><br><span class="line">      [</span><br><span class="line">        <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, <span class="string">&quot;hi, &quot;</span> + <span class="variable language_">this</span>.<span class="property">msg</span>),</span><br><span class="line">        <span class="title function_">h</span>(<span class="title class_">Foo</span>, &#123;</span><br><span class="line">          <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      ]</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// composition api</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&quot;mini-vue-hhh&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="功能一-通过-setup-传值"><a href="#功能一-通过-setup-传值" class="headerlink" title="功能一 通过 setup 传值"></a>功能一 通过 setup 传值</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initProps</span>(<span class="params">instance, rawProps</span>) &#123;</span><br><span class="line">  instance.<span class="property">props</span> = rawProps;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">  <span class="comment">// attrs</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setupComponent</span>(<span class="params">instance</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">  <span class="title function_">initProps</span>(instance, instance.<span class="property">vnode</span>.<span class="property">props</span>);</span><br><span class="line">  <span class="comment">// initSlots()</span></span><br><span class="line">  <span class="title function_">setupStatefulComponent</span>(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123; <span class="attr">_</span>: instance &#125;, <span class="title class_">PublicInstanceProxyHandlers</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// function object</span></span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">setup</span>(instance.<span class="property">props</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">handleSetupResult</span>(instance, setupResult);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="功能二-在-render-中通过-this-访问-props-中的属性"><a href="#功能二-在-render-中通过-this-访问-props-中的属性" class="headerlink" title="功能二 在 render 中通过 this 访问 props 中的属性"></a>功能二 在 render 中通过 this 访问 props 中的属性</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> publicPropertiesMap = &#123;</span><br><span class="line">  <span class="attr">$el</span>: <span class="function">(<span class="params">i</span>) =&gt;</span> i.<span class="property">vnode</span>.<span class="property">el</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">PublicInstanceProxyHandlers</span> = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">&#123; _: instance &#125;, key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; setupState, props &#125; = instance;</span><br><span class="line">    <span class="comment">// if (key in setupState) &#123;</span></span><br><span class="line">    <span class="comment">//   return setupState[key];</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">hasOwn</span> = (<span class="params">val, key</span>) =&gt; <span class="title class_">Object</span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(val, key);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(setupState, key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> setupState[key];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> props[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (key === &quot;$el&quot;) &#123;</span></span><br><span class="line">    <span class="comment">//   return instance.vnode.el;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">const</span> publicGetter = publicPropertiesMap[key];</span><br><span class="line">    <span class="keyword">if</span> (publicGetter) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">publicGetter</span>(instance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="功能三-props-是-shallowreadonly"><a href="#功能三-props-是-shallowreadonly" class="headerlink" title="功能三 props 是 shallowreadonly"></a>功能三 props 是 shallowreadonly</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123; <span class="attr">_</span>: instance &#125;, <span class="title class_">PublicInstanceProxyHandlers</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// function object</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">setup</span>(<span class="title function_">shallowReadonly</span>(instance.<span class="property">props</span>));</span><br><span class="line"></span><br><span class="line">    <span class="title function_">handleSetupResult</span>(instance, setupResult);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createActiveObject</span>(<span class="params">raw, baseHandlers</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(raw)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`raw <span class="subst">$&#123;raw&#125;</span> 必须是一个对象`</span>);</span><br><span class="line">    <span class="keyword">return</span> raw;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(raw, baseHandlers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-emit-功能"><a href="#实现-emit-功能" class="headerlink" title="实现 emit 功能"></a>实现 emit 功能</h2><ol>
<li>setup 需要 emit 参数</li>
<li>组件 A 发射事件 event</li>
<li>组件 B 监听事件 onEvent</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&quot;../../lib/mini-vue.esm.js&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Foo</span> = &#123;</span><br><span class="line">  <span class="comment">// 1. setup 需要 emit 参数</span></span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props, &#123; emit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">emitAdd</span> = (<span class="params">args</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;emit add&quot;</span>);</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&quot;add&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      emitAdd,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> btn = <span class="title function_">h</span>(</span><br><span class="line">      <span class="string">&quot;button&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">onClick</span>: <span class="variable language_">this</span>.<span class="property">emitAdd</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;emitAdd&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> foo = <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123;&#125;, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, [foo, btn]);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&quot;../../lib/mini-vue.esm.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Foo</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./Foo.js&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">App</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;App&quot;</span>,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, [</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, <span class="string">&quot;App&quot;</span>),</span><br><span class="line">      <span class="title function_">h</span>(<span class="title class_">Foo</span>, &#123;</span><br><span class="line">        <span class="title function_">onAdd</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onAdd&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;),</span><br><span class="line">    ]);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createComponentInstance</span>(<span class="params">vnode</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> component = &#123;</span><br><span class="line">    vnode,</span><br><span class="line">    <span class="attr">type</span>: vnode.<span class="property">type</span>,</span><br><span class="line">    <span class="attr">setupState</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">props</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">emit</span>:<span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  component.<span class="property">emit</span> = emit.<span class="title function_">bind</span>(<span class="literal">null</span>, component) <span class="keyword">as</span> any;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> component;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123; <span class="attr">_</span>: instance &#125;, <span class="title class_">PublicInstanceProxyHandlers</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// function object</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">setup</span>(<span class="title function_">shallowReadonly</span>(instance.<span class="property">props</span>), &#123;</span><br><span class="line">      <span class="attr">emit</span>: instance.<span class="property">emit</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">handleSetupResult</span>(instance, setupResult);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; camelize, toHandlerKey &#125; <span class="keyword">from</span> <span class="string">&quot;../shared/index&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">emit</span>(<span class="params">instance, event, ...args</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;emit&quot;</span>, event, instance);</span><br><span class="line">  <span class="keyword">const</span> &#123; props &#125; = instance;</span><br><span class="line">  <span class="comment">//TPP</span></span><br><span class="line">  <span class="comment">//   先去写一个特定的行为 -&gt; 重构为通用行为</span></span><br><span class="line">  <span class="comment">// add -&gt; Add</span></span><br><span class="line">  <span class="comment">// add-foo -&gt; AddFoo</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handlerName = <span class="title function_">toHandlerKey</span>(<span class="title function_">camelize</span>(event));</span><br><span class="line">  <span class="keyword">const</span> handler = props[handlerName];</span><br><span class="line">  handler &amp;&amp; <span class="title function_">handler</span>(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-slots-功能"><a href="#实现-slots-功能" class="headerlink" title="实现 slots 功能"></a>实现 slots 功能</h2><h2 id="实现-Fragment-和-Text-类型节点"><a href="#实现-Fragment-和-Text-类型节点" class="headerlink" title="实现 Fragment 和 Text 类型节点"></a>实现 Fragment 和 Text 类型节点</h2><h3 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag, type &#125; = vnode;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Fragment</span>:</span><br><span class="line">      <span class="title function_">processFragment</span>(vnode, container);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span>) &#123;</span><br><span class="line">        <span class="title function_">processElenet</span>(vnode, container);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">STATEFUL_COMPONENT</span>) &#123;</span><br><span class="line">        <span class="title function_">processComponent</span>(vnode, container);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">processFragment</span>(<span class="params">vnode: any, container: any</span>) &#123;</span><br><span class="line">  <span class="title function_">mountChildren</span>(vnode, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Fragment</span> = <span class="title class_">Symbol</span>(<span class="string">&quot;Fragment&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Fragment</span>, createVNode &#125; <span class="keyword">from</span> <span class="string">&quot;../vnode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderSlots</span>(<span class="params">slots, name, props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> slot = slots[name];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (slot) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> slot === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="title class_">Fragment</span>, &#123;&#125;, <span class="title function_">slot</span>(props));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现渲染-Text"><a href="#实现渲染-Text" class="headerlink" title="实现渲染 Text"></a>实现渲染 Text</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> app = <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, <span class="string">&quot;App&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> foo = <span class="title function_">h</span>(</span><br><span class="line">      <span class="title class_">Foo</span>,</span><br><span class="line">      &#123;&#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">header</span>: <span class="function">(<span class="params">&#123; age &#125;</span>) =&gt;</span> [</span><br><span class="line">          <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123;&#125;, <span class="string">&quot;header&quot;</span> + age),</span><br><span class="line">          <span class="title function_">createTextVNode</span>(<span class="string">&quot;你好呀&quot;</span>),</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">footer</span>: <span class="function">() =&gt;</span> <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123;&#125;, <span class="string">&quot;footer&quot;</span>),</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, [app, foo]);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createTextVNode</span>(<span class="params">text</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="title class_">Text</span>, &#123;&#125;, text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag, type &#125; = vnode;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Fragment</span>:</span><br><span class="line">      <span class="title function_">processFragment</span>(vnode, container);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Text</span>:</span><br><span class="line">      <span class="title function_">processText</span>(vnode, container);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span>) &#123;</span><br><span class="line">        <span class="title function_">processElenet</span>(vnode, container);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">STATEFUL_COMPONENT</span>) &#123;</span><br><span class="line">        <span class="title function_">processComponent</span>(vnode, container);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">processText</span>(<span class="params">vnode: any, container: any</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; children &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> textNode = (vnode.<span class="property">el</span> = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(children));</span><br><span class="line">  container.<span class="title function_">append</span>(textNode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-getCurrentInstance"><a href="#实现-getCurrentInstance" class="headerlink" title="实现 getCurrentInstance"></a>实现 getCurrentInstance</h2><p>返回当前组件的实例对象, 必须在 setup 中使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> currentInstance = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCurrentInstance</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> currentInstance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setCurrentInstance</span>(<span class="params">instance</span>) &#123;</span><br><span class="line">  currentInstance = instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123; <span class="attr">_</span>: instance &#125;, <span class="title class_">PublicInstanceProxyHandlers</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span>;</span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// function object</span></span><br><span class="line">    <span class="title function_">setCurrentInstance</span>(instance);</span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">setup</span>(<span class="title function_">shallowReadonly</span>(instance.<span class="property">props</span>), &#123;</span><br><span class="line">      <span class="attr">emit</span>: instance.<span class="property">emit</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title function_">setCurrentInstance</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="title function_">handleSetupResult</span>(instance, setupResult);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line"> <span class="keyword">const</span> instance = <span class="title function_">getCurrentInstance</span>();</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;App&quot;</span>, instance);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="实现-provide-x2F-inject"><a href="#实现-provide-x2F-inject" class="headerlink" title="实现 provide&#x2F;inject"></a>实现 provide&#x2F;inject</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getCurrentInstance &#125; <span class="keyword">from</span> <span class="string">&quot;./component&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">provide</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">currentInstance</span>: any = <span class="title function_">getCurrentInstance</span>();</span><br><span class="line">  <span class="keyword">if</span> (currentInstance) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; provides &#125; = currentInstance;</span><br><span class="line">    <span class="keyword">const</span> parentProvides = currentInstance.<span class="property">parent</span>.<span class="property">provides</span>;</span><br><span class="line">    <span class="comment">// init</span></span><br><span class="line">    <span class="keyword">if</span> (provides === parentProvides) &#123;</span><br><span class="line">      provides = currentInstance.<span class="property">provides</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(parentProvides);</span><br><span class="line">    &#125;</span><br><span class="line">    provides[key] = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">inject</span>(<span class="params">key, defaultValue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">currentInstance</span>: any = <span class="title function_">getCurrentInstance</span>();</span><br><span class="line">  <span class="keyword">if</span> (currentInstance) &#123;</span><br><span class="line">    <span class="keyword">const</span> parentProvides = currentInstance.<span class="property">parent</span>.<span class="property">provides</span>;</span><br><span class="line">    <span class="keyword">if</span> (key <span class="keyword">in</span> parentProvides) &#123;</span><br><span class="line">      <span class="keyword">return</span> parentProvides[key];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultValue) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> defaultValue === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">defaultValue</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现自定义渲染器-custom-renderer"><a href="#实现自定义渲染器-custom-renderer" class="headerlink" title="实现自定义渲染器 custom renderer"></a>实现自定义渲染器 custom renderer</h2><blockquote>
<p>介绍</p>
</blockquote>
<p><code>createRenderer</code> 是 Vue 3 中的一个函数，它是用于创建自定义渲染器的工厂函数。在 Vue 3 中，渲染器负责将组件的虚拟 DOM 树转换为实际的 DOM 元素，并管理组件的更新和渲染过程。通过创建自定义渲染器，你可以实现更多定制化的渲染逻辑，比如将 Vue 组件渲染到不同的目标上，比如 Canvas、WebGL、命令行等。</p>
<p><code>createRenderer</code> 函数接受一个包含一系列方法的对象作为参数，用来定义自定义渲染器的行为。这些方法包括：</p>
<ol>
<li><p><code>createApp</code>: 这是一个工厂函数，用于创建根组件实例。它接受一个根组件选项对象作为参数，返回一个包含根组件实例的应用程序对象。</p>
</li>
<li><p><code>render</code>: 这是用来执行渲染的核心函数。它接受两个参数：渲染的目标 (通常是 DOM 元素) 和要渲染的虚拟 DOM。该函数会将虚拟 DOM 转换为实际的 DOM 元素，并将其插入到目标中。</p>
</li>
<li><p><code>hydrate</code>: 这是用于将服务器渲染的 HTML 在客户端激活的函数。它接受两个参数：要激活的根组件实例和要激活的 DOM 元素。它会将已有的服务器渲染的 HTML 和客户端生成的虚拟 DOM 进行合并，从而避免重复渲染。</p>
</li>
<li><p><code>createBlock</code>: 这是用来创建虚拟 DOM 的函数。它接受三个参数：标签名、属性对象和子节点数组，返回一个表示虚拟 DOM 的 block 对象。</p>
</li>
</ol>
<p>通过实现上述方法，你可以创建一个完整的自定义渲染器，从而控制 Vue 组件的渲染流程和输出方式。这使得你可以在更多领域内使用 Vue，例如在游戏引擎中渲染 Vue 组件，或者在特定的环境中将 Vue 组件渲染为命令行输出。</p>
<p>总之，<code>createRenderer</code> 是 Vue 3 提供的一个强大工具，允许开发者在更广泛的应用场景中使用 Vue 的渲染能力，实现更多定制化的渲染逻辑。</p>
<p>默认 vue3 是渲染到 DOM 平台的, 可以使用 createRenderer 将其渲染到 canvas 上</p>
<h3 id="renderer-实现分析"><a href="#renderer-实现分析" class="headerlink" title="renderer 实现分析"></a>renderer 实现分析</h3><p>canvas 创建元素通过<code>new Element()</code>,设置属性通过<code>el.x = 10</code>, 而 DOM 中通过<code>document.createElement</code>和<code>setAttribute</code>;<br>都是虚拟节点转为真实节点的过程, 只是具体实现不同, 但意图是相同的;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountElement</span>(<span class="params">vnode, container, parentComponent</span>) &#123;</span><br><span class="line">  <span class="comment">// canvas</span></span><br><span class="line">  <span class="comment">// new Element</span></span><br><span class="line">  <span class="keyword">const</span> el = (vnode.<span class="property">el</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(vnode.<span class="property">type</span>));</span><br><span class="line">  <span class="keyword">const</span> &#123; children, shapeFlag &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">    el.<span class="property">textContent</span> = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">    <span class="title function_">mountChildren</span>(vnode, el, parentComponent);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; props &#125; = vnode;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">const</span> val = props[key];</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">isOn</span> = (<span class="params">key: string</span>) =&gt; <span class="regexp">/^on[A-Z]/</span>.<span class="title function_">test</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isOn</span>(key)) &#123;</span><br><span class="line">      <span class="keyword">const</span> event = key.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">toLocaleLowerCase</span>();</span><br><span class="line">      el.<span class="title function_">addEventListener</span>(event, val);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      el.<span class="title function_">setAttribute</span>(key, val);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// canvas</span></span><br><span class="line">  <span class="comment">// el.x = 10</span></span><br><span class="line">  container.<span class="title function_">append</span>(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以让它不依赖于具体的实现, 而是依赖稳定的接口;</p>
<p>通过一个 createRenderer 函数拿到用户传入 options 中的具体实现函数来决定具体渲染到什么平台</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRenderer</span>(<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    createElement,</span><br><span class="line">    patchProp,</span><br><span class="line">    insert</span><br><span class="line">  &#125; = options;</span><br></pre></td></tr></table></figure>

<h3 id="渲染到-dom-平台"><a href="#渲染到-dom-平台" class="headerlink" title="渲染到 dom 平台"></a>渲染到 dom 平台</h3><p>新建 runtime-dom&#x2F;index.ts, 并在其中实现具体的接口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRenderer &#125; <span class="keyword">from</span> <span class="string">&quot;../runtime-core&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">type</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">patchProp</span>(<span class="params">el, key, val</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isOn</span> = (<span class="params">key: string</span>) =&gt; <span class="regexp">/^on[A-Z]/</span>.<span class="title function_">test</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isOn</span>(key)) &#123;</span><br><span class="line">    <span class="keyword">const</span> event = key.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">toLocaleLowerCase</span>();</span><br><span class="line">    el.<span class="title function_">addEventListener</span>(event, val);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    el.<span class="title function_">setAttribute</span>(key, val);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">insert</span>(<span class="params">el, container</span>) &#123;</span><br><span class="line">  container.<span class="title function_">append</span>(el);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">renderer</span>: any = <span class="title function_">createRenderer</span>(&#123;</span><br><span class="line">  createElement,</span><br><span class="line">  patchProp,</span><br><span class="line">  insert,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> renderer.<span class="title function_">createApp</span>(...args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;../runtime-core&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="实现-custom-renderer"><a href="#实现-custom-renderer" class="headerlink" title="实现 custom renderer"></a>实现 custom renderer</h3><ol>
<li>引入 pixi.js</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://pixijs.download/release/pixi.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>App.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&quot;../../lib/mini-vue.esm.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">App</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;App&quot;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">x</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">y</span>: <span class="number">100</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&quot;rect&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">x</span>: <span class="variable language_">this</span>.<span class="property">x</span>,</span><br><span class="line">      <span class="attr">y</span>: <span class="variable language_">this</span>.<span class="property">y</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>main.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRenderer &#125; <span class="keyword">from</span> <span class="string">&quot;../../lib/mini-vue.esm.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">App</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./App.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> game = <span class="keyword">new</span> <span class="variable constant_">PIXI</span>.<span class="title class_">Application</span>(&#123;</span><br><span class="line">  <span class="attr">width</span>: <span class="number">500</span>,</span><br><span class="line">  <span class="attr">height</span>: <span class="number">500</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">append</span>(game.<span class="property">view</span>);</span><br><span class="line"><span class="keyword">const</span> renderer = <span class="title function_">createRenderer</span>(&#123;</span><br><span class="line">  <span class="title function_">createElement</span>(<span class="params">type</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&quot;rect&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> rect = <span class="keyword">new</span> <span class="variable constant_">PIXI</span>.<span class="title class_">Graphics</span>();</span><br><span class="line">      rect.<span class="title function_">beginFill</span>(<span class="number">0xffffff</span>);</span><br><span class="line">      rect.<span class="title function_">drawRect</span>(<span class="number">100</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">      rect.<span class="title function_">endFill</span>();</span><br><span class="line">      <span class="keyword">return</span> rect;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">patchProp</span>(<span class="params">el, key, val</span>) &#123;</span><br><span class="line">    el[key] = val;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">insert</span>(<span class="params">el, parent</span>) &#123;</span><br><span class="line">    parent.<span class="title function_">addChild</span>(el);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">renderer.<span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">mount</span>(game.<span class="property">stage</span>);</span><br></pre></td></tr></table></figure>

<h2 id="更新-element-流程搭建"><a href="#更新-element-流程搭建" class="headerlink" title="更新 element 流程搭建"></a>更新 element 流程搭建</h2><p>获取新旧节点并进行比较, 然后更新<br>使用 effect 来获取新旧节点: 当触发 get 操作的时候收集依赖, 可以得到一个 subTree, 当触发 set 操作的时候又会再次执行依赖从而得到一个更新的 subTree;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupRenderEffect</span>(<span class="params">instance: any, initialVNode, container</span>) &#123;</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; proxy &#125; = instance;</span><br><span class="line">    <span class="comment">// console.log(proxy, &quot;proxy&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> subTree = instance.<span class="property">render</span>.<span class="title function_">call</span>(proxy);</span><br><span class="line">    <span class="comment">//vnode-&gt;patch</span></span><br><span class="line">    <span class="comment">// vnode -&gt; element -&gt; mountElement</span></span><br><span class="line">    <span class="title function_">patch</span>(subTree, container, instance);</span><br><span class="line"></span><br><span class="line">    initialVNode.<span class="property">el</span> = subTree.<span class="property">el</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这样做又会每次都将新的节点挂载到原来的节点上(patch), 我们需要把更新和初始化分割开来;<br>在 component 中加入变量 isMounted 来进行区分;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupRenderEffect</span>(<span class="params">instance: any, initialVNode, container</span>) &#123;</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!instance.<span class="property">isMounted</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;init&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; proxy &#125; = instance;</span><br><span class="line">      <span class="comment">// console.log(proxy, &quot;proxy&quot;);</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> subTree = (instance.<span class="property">subTree</span> = instance.<span class="property">render</span>.<span class="title function_">call</span>(proxy));</span><br><span class="line">      <span class="comment">//vnode-&gt;patch</span></span><br><span class="line">      <span class="comment">// vnode -&gt; element -&gt; mountElement</span></span><br><span class="line">      <span class="title function_">patch</span>(<span class="literal">null</span>, subTree, container, instance);</span><br><span class="line"></span><br><span class="line">      initialVNode.<span class="property">el</span> = subTree.<span class="property">el</span>;</span><br><span class="line">      instance.<span class="property">isMounted</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;update&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> &#123; proxy &#125; = instance;</span><br><span class="line">      <span class="comment">// console.log(proxy, &quot;proxy&quot;);</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> subTree = instance.<span class="property">render</span>.<span class="title function_">call</span>(proxy);</span><br><span class="line">      <span class="keyword">const</span> prevSubtree = instance.<span class="property">subTree</span>;</span><br><span class="line">      instance.<span class="property">subTree</span> = subTree;</span><br><span class="line">      <span class="title function_">patch</span>(prevSubtree, subTree, container, instance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="更新-props"><a href="#更新-props" class="headerlink" title="更新 props"></a>更新 props</h2><h3 id="n1-n2-属性的值发生了变化-gt-修改该属性的值"><a href="#n1-n2-属性的值发生了变化-gt-修改该属性的值" class="headerlink" title="n1, n2 属性的值发生了变化 -&gt; 修改该属性的值"></a>n1, n2 属性的值发生了变化 -&gt; 修改该属性的值</h3><p>遍历 n2 的属性与 n1 进行对比</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchProps</span>(<span class="params">el, oldProps, newProps</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevProp = oldProps[key];</span><br><span class="line">    <span class="keyword">const</span> nextProp = newProps[key];</span><br><span class="line">    <span class="keyword">if</span> (prevProp !== nextProp) &#123;</span><br><span class="line">      <span class="title function_">hostPatchProp</span>(el, key, prevProp, nextProp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="该属性为-null-x2F-undefined-gt-删除该属性和值"><a href="#该属性为-null-x2F-undefined-gt-删除该属性和值" class="headerlink" title="该属性为 null&#x2F;undefined -&gt; 删除该属性和值"></a>该属性为 null&#x2F;undefined -&gt; 删除该属性和值</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchProp</span>(<span class="params">el, key, preVal, nextVal</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isOn</span> = (<span class="params">key: string</span>) =&gt; <span class="regexp">/^on[A-Z]/</span>.<span class="title function_">test</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isOn</span>(key)) &#123;</span><br><span class="line">    <span class="keyword">const</span> event = key.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">toLocaleLowerCase</span>();</span><br><span class="line">    el.<span class="title function_">addEventListener</span>(event, nextVal);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextVal === <span class="literal">null</span> || nextVal === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      el.<span class="title function_">removeAttribute</span>(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      el.<span class="title function_">setAttribute</span>(key, nextVal);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="n1-有-n2-删除了的属性-gt-删除该属性和值"><a href="#n1-有-n2-删除了的属性-gt-删除该属性和值" class="headerlink" title="n1 有, n2 删除了的属性 -&gt; 删除该属性和值"></a>n1 有, n2 删除了的属性 -&gt; 删除该属性和值</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchProps</span>(<span class="params">el, oldProps, newProps</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldProps !== newProps) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">      <span class="keyword">const</span> prevProp = oldProps[key];</span><br><span class="line">      <span class="keyword">const</span> nextProp = newProps[key];</span><br><span class="line">      <span class="keyword">if</span> (prevProp !== nextProp) &#123;</span><br><span class="line">        <span class="title function_">hostPatchProp</span>(el, key, prevProp, nextProp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oldProps !== <span class="variable constant_">EMPTY_OBJ</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(key <span class="keyword">in</span> newProps)) &#123;</span><br><span class="line">          <span class="title function_">hostPatchProp</span>(el, key, oldProps[key], <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="更新-element-的-children"><a href="#更新-element-的-children" class="headerlink" title="更新 element 的 children"></a>更新 element 的 children</h2><h3 id="n1-text-n2-text"><a href="#n1-text-n2-text" class="headerlink" title="n1: text; n2: text;"></a>n1: text; n2: text;</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchChildren</span>(<span class="params">n1, n2, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> prevShapeFlag = n1.<span class="property">shapeFlag</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag &#125; = n2;</span><br><span class="line">  <span class="keyword">const</span> c1 = n1.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">const</span> c2 = n2.<span class="property">children</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="comment">// 1. 把old节点的children清空</span></span><br><span class="line">      <span class="title function_">unmountChildren</span>(c1);</span><br><span class="line">      <span class="comment">//  2.设置text</span></span><br><span class="line">      <span class="comment">// hostSetElementText(container, c2);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c1 !== c2) &#123;</span><br><span class="line">      <span class="title function_">hostSetElementText</span>(container, c2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="n1-array-n2-text"><a href="#n1-array-n2-text" class="headerlink" title="n1: array; n2: text;"></a>n1: array; n2: text;</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h, ref &#125; <span class="keyword">from</span> <span class="string">&quot;../../lib/mini-vue.esm.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> nextChildren = <span class="string">&quot;newChildren&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> prevChildren = [<span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, <span class="string">&quot;A&quot;</span>), <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, <span class="string">&quot;B&quot;</span>)];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;ArrayToText&quot;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> isChange = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">isChange</span> = isChange;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      isChange,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">return</span> self.<span class="property">isChange</span> === <span class="literal">true</span></span><br><span class="line">      ? <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, nextChildren)</span><br><span class="line">      : <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, prevChildren);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchElement</span>(<span class="params">n1, n2, container</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;patch&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;n1&quot;</span>, n1);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;n2&quot;</span>, n2);</span><br><span class="line">  <span class="keyword">const</span> oldProps = n1.<span class="property">props</span> || <span class="variable constant_">EMPTY_OBJ</span>;</span><br><span class="line">  <span class="keyword">const</span> newProps = n2.<span class="property">props</span> || <span class="variable constant_">EMPTY_OBJ</span>;</span><br><span class="line">  <span class="comment">// n2是没有el的, 所以需要重新赋值一下</span></span><br><span class="line">  <span class="keyword">const</span> el = (n2.<span class="property">el</span> = n1.<span class="property">el</span>);</span><br><span class="line">  <span class="title function_">patchChildren</span>(n1, n2, el);</span><br><span class="line">  <span class="title function_">patchProps</span>(el, oldProps, newProps);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">patchChildren</span>(<span class="params">n1, n2, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> prevShapeFlag = n1.<span class="property">shapeFlag</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag &#125; = n2;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="comment">// 1. 把old节点的children清空</span></span><br><span class="line">      <span class="title function_">unmountChildren</span>(n1.<span class="property">children</span>);</span><br><span class="line">      <span class="comment">//  2.设置text</span></span><br><span class="line">      <span class="title function_">hostSetElementText</span>(container, n2.<span class="property">children</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">unmountChildren</span>(<span class="params">children</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> el = children[i].<span class="property">el</span>;</span><br><span class="line">    <span class="title function_">hostRemove</span>(el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">remove</span>(<span class="params">child</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> parent = child.<span class="property">parentNode</span>;</span><br><span class="line">  <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">    parent.<span class="title function_">removeChild</span>(child);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setElementText</span>(<span class="params">el, text</span>) &#123;</span><br><span class="line">  el.<span class="property">textContent</span> = text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="n1-text-n2-array"><a href="#n1-text-n2-array" class="headerlink" title="n1: text; n2: array;"></a>n1: text; n2: array;</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchChildren</span>(<span class="params">n1, n2, container, parentComponent</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> prevShapeFlag = n1.<span class="property">shapeFlag</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag &#125; = n2;</span><br><span class="line">  <span class="keyword">const</span> c1 = n1.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">const</span> c2 = n2.<span class="property">children</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">    <span class="comment">// array -&gt; text</span></span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="comment">// 1. 把old节点的children清空</span></span><br><span class="line">      <span class="title function_">unmountChildren</span>(c1);</span><br><span class="line">      <span class="comment">//  2.设置text</span></span><br><span class="line">      <span class="comment">// hostSetElementText(container, c2);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// text -&gt; text</span></span><br><span class="line">    <span class="keyword">if</span> (c1 !== c2) &#123;</span><br><span class="line">      <span class="title function_">hostSetElementText</span>(container, c2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// text -&gt; array</span></span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TEXT_CHILDREN</span>) &#123;</span><br><span class="line">      <span class="title function_">hostSetElementText</span>(container, <span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="title function_">mountChildren</span>(n2.<span class="property">children</span>, container, parentComponent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="n1-array-n2-array-双端对比-diff-算法"><a href="#n1-array-n2-array-双端对比-diff-算法" class="headerlink" title="n1: array; n2: array; 双端对比 diff 算法"></a>n1: array; n2: array; 双端对比 diff 算法</h3><p>核心就是算出中间乱序的范围</p>
<ol>
<li>创建新的</li>
<li>删除老的</li>
<li>移动位置</li>
</ol>
<h4 id="左侧对比"><a href="#左侧对比" class="headerlink" title="左侧对比"></a>左侧对比</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 左侧对比</span></span><br><span class="line"><span class="comment">// (a b) c</span></span><br><span class="line"><span class="comment">// (a b) d e</span></span><br><span class="line"><span class="keyword">const</span> nextChildren = [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;A&quot;</span> &#125;, <span class="string">&quot;A&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;C&quot;</span> &#125;, <span class="string">&quot;C&quot;</span>),</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> prevChildren = [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;A&quot;</span> &#125;, <span class="string">&quot;A&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;D&quot;</span> &#125;, <span class="string">&quot;D&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;E&quot;</span> &#125;, <span class="string">&quot;E&quot;</span>),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchKeyedChildren</span>(<span class="params">c1, c2, container, parentComponent</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> e1 = c1.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> e2 = c2.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i];</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(n1, n2, container, parentComponent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="右侧对比"><a href="#右侧对比" class="headerlink" title="右侧对比"></a>右侧对比</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 右侧对比</span></span><br><span class="line"><span class="comment">// a (b c)</span></span><br><span class="line"><span class="comment">// d e (b c)</span></span><br><span class="line"><span class="keyword">const</span> nextChildren = [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;A&quot;</span> &#125;, <span class="string">&quot;A&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;C&quot;</span> &#125;, <span class="string">&quot;C&quot;</span>),</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> prevChildren = [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;D&quot;</span> &#125;, <span class="string">&quot;D&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;E&quot;</span> &#125;, <span class="string">&quot;E&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;C&quot;</span> &#125;, <span class="string">&quot;E&quot;</span>),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchKeyedChildren</span>(<span class="params">c1, c2, container, parentComponent</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> e1 = c1.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> e2 = c2.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 左侧</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i];</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(n1, n2, container, parentComponent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  <span class="comment">// 右侧</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i];</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(n1, n2, container, parentComponent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    e1--;</span><br><span class="line">    e2--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="新的比老的长"><a href="#新的比老的长" class="headerlink" title="新的比老的长"></a>新的比老的长</h4><p>左侧</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//左侧</span></span><br><span class="line"><span class="comment">// (a b)</span></span><br><span class="line"><span class="comment">// (a b) c</span></span><br><span class="line"><span class="comment">// i = 2, e1 = 1, e2 = 2;</span></span><br><span class="line"><span class="keyword">const</span> prevChildren = [<span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;A&quot;</span> &#125;, <span class="string">&quot;A&quot;</span>), <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>)];</span><br><span class="line"><span class="keyword">const</span> nextChildren = [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;A&quot;</span> &#125;, <span class="string">&quot;A&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;C&quot;</span> &#125;, <span class="string">&quot;C&quot;</span>),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchKeyedChildren</span>(<span class="params">c1, c2, container, parentComponent</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> e1 = c1.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> e2 = c2.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 左侧</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i];</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(n1, n2, container, parentComponent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  <span class="comment">// 右侧</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i];</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(n1, n2, container, parentComponent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    e1--;</span><br><span class="line">    e2--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 新的比老的多</span></span><br><span class="line">  <span class="keyword">if</span> (i &gt; e1) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt;= e2) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(<span class="literal">null</span>, c2[i], container, parentComponent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>右侧对比</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//右侧</span></span><br><span class="line"><span class="comment">// (a b)</span></span><br><span class="line"><span class="comment">// c (a b)</span></span><br><span class="line"><span class="comment">// i = 0, e1 = -1, e2 = 0;</span></span><br><span class="line"><span class="keyword">const</span> prevChildren = [<span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;A&quot;</span> &#125;, <span class="string">&quot;A&quot;</span>), <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>)];</span><br><span class="line"><span class="keyword">const</span> nextChildren = [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;C&quot;</span> &#125;, <span class="string">&quot;C&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;A&quot;</span> &#125;, <span class="string">&quot;A&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;p&quot;</span>, &#123; <span class="attr">key</span>: <span class="string">&quot;B&quot;</span> &#125;, <span class="string">&quot;B&quot;</span>),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h4 id="完整-diff-算法"><a href="#完整-diff-算法" class="headerlink" title="完整 diff 算法"></a>完整 diff 算法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isSameVnodeType</span>(<span class="params">n1, n2</span>) &#123;</span><br><span class="line">  <span class="comment">// type</span></span><br><span class="line">  <span class="comment">// key</span></span><br><span class="line">  <span class="keyword">return</span> n1.<span class="property">type</span> === n2.<span class="property">type</span> &amp;&amp; n1.<span class="property">key</span> === n2.<span class="property">key</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">patchKeyedChildren</span>(<span class="params">c1, c2, container, parentComponent, parentAnchor</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> l2 = c2.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> e1 = c1.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> e2 = l2 - <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 左侧</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i];</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[i];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(n1, n2, container, parentComponent, parentAnchor);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  <span class="comment">// 右侧</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[e1];</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[e2];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(n1, n2)) &#123;</span><br><span class="line">      <span class="title function_">patch</span>(n1, n2, container, parentComponent, parentAnchor);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    e1--;</span><br><span class="line">    e2--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 3. 新的比老的多</span></span><br><span class="line">  <span class="keyword">if</span> (i &gt; e1) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt;= e2) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextPos = e2 + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">const</span> anchor = nextPos &lt; l2 ? c2[nextPos].<span class="property">el</span> : parentAnchor;</span><br><span class="line">      <span class="keyword">while</span> (i &lt;= e2) &#123;</span><br><span class="line">        <span class="title function_">patch</span>(<span class="literal">null</span>, c2[i], container, parentComponent, anchor);</span><br><span class="line">        i++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i &gt; e2) &#123;</span><br><span class="line">    <span class="comment">// 老比新多</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt;= e1) &#123;</span><br><span class="line">      <span class="title function_">hostRemove</span>(c1[i].<span class="property">el</span>);</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 中间对比</span></span><br><span class="line">    <span class="keyword">let</span> s1 = i;</span><br><span class="line">    <span class="keyword">let</span> s2 = i;</span><br><span class="line">    <span class="keyword">const</span> toBePatched = e2 - s2 + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> patched = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> keyToNewIndexMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="keyword">const</span> newIndexToOldIndexMap = <span class="keyword">new</span> <span class="title class_">Array</span>(toBePatched);</span><br><span class="line">    <span class="keyword">let</span> moved = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; toBePatched; i++) &#123;</span><br><span class="line">      newIndexToOldIndexMap[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = s2; i &lt;= e2; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextChild = c2[i];</span><br><span class="line">      keyToNewIndexMap.<span class="title function_">set</span>(nextChild.<span class="property">key</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = s1; i &lt;= e1; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> prevChild = c1[i];</span><br><span class="line">      <span class="keyword">if</span> (patched &gt;= toBePatched) &#123;</span><br><span class="line">        <span class="title function_">hostRemove</span>(prevChild.<span class="property">el</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> newIndex;</span><br><span class="line">      <span class="keyword">if</span> (prevChild.<span class="property">key</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">        newIndex = keyToNewIndexMap.<span class="title function_">get</span>(prevChild.<span class="property">key</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = s2; j &lt;= e2; j++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isSameVnodeType</span>(prevChild, c2[j])) &#123;</span><br><span class="line">            newIndex = j;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (newIndex === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="title function_">hostRemove</span>(prevChild.<span class="property">el</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (newIndex &gt;= maxNewIndexSoFar) &#123;</span><br><span class="line">          maxNewIndexSoFar = newIndex;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          moved = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        newIndexToOldIndexMap[newIndex - s2] = i + <span class="number">1</span>;</span><br><span class="line">        <span class="title function_">patch</span>(prevChild, c2[newIndex], container, parentComponent, <span class="literal">null</span>);</span><br><span class="line">        patched++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> increasingNewIndexSequence = moved</span><br><span class="line">      ? <span class="title function_">getSequence</span>(newIndexToOldIndexMap)</span><br><span class="line">      : [];</span><br><span class="line">    <span class="keyword">let</span> j = increasingNewIndexSequence.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = toBePatched; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextIndex = i + s2;</span><br><span class="line">      <span class="keyword">const</span> nextChild = c2[nextIndex];</span><br><span class="line">      <span class="keyword">const</span> anchor = nextIndex + <span class="number">1</span> &lt; l2 ? c2[nextIndex + <span class="number">1</span>].<span class="property">el</span> : <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (newIndexToOldIndexMap[i] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="title function_">patch</span>(<span class="literal">null</span>, nextChild, container, parentComponent, anchor);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (moved) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j &lt; <span class="number">0</span> || i !== increasingNewIndexSequence[j]) &#123;</span><br><span class="line">          <span class="title function_">hostInsert</span>(nextChild.<span class="property">el</span>, container, anchor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          j--;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="最长递增子序列算法"><a href="#最长递增子序列算法" class="headerlink" title="最长递增子序列算法"></a>最长递增子序列算法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getSequence</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> p = arr.<span class="title function_">slice</span>();</span><br><span class="line">  <span class="keyword">const</span> result = [<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">let</span> i, j, u, v, c;</span><br><span class="line">  <span class="keyword">const</span> len = arr.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> arrI = arr[i];</span><br><span class="line">    <span class="keyword">if</span> (arrI !== <span class="number">0</span>) &#123;</span><br><span class="line">      j = result[result.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span> (arr[j] &lt; arrI) &#123;</span><br><span class="line">        p[i] = j;</span><br><span class="line">        result.<span class="title function_">push</span>(i);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      u = <span class="number">0</span>;</span><br><span class="line">      v = result.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (u &lt; v) &#123;</span><br><span class="line">        c = (u + v) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (arr[result[c]] &lt; arrI) &#123;</span><br><span class="line">          u = c + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          v = c;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (arrI &lt; arr[result[u]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (u &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          p[i] = result[u - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        result[u] = i;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  u = result.<span class="property">length</span>;</span><br><span class="line">  v = result[u - <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">while</span> (u-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    result[u] = v;</span><br><span class="line">    v = p[v];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现组件更新功能"><a href="#实现组件更新功能" class="headerlink" title="实现组件更新功能"></a>实现组件更新功能</h2><p>effect会返回一个runner;<br>我们给instance.update &#x3D; effect() 赋值effect执行的结果;</p>
<h2 id="实现nextTick"><a href="#实现nextTick" class="headerlink" title="实现nextTick"></a>实现nextTick</h2><p>nextTick方便我们获取更新完成之后视图的数据<br>当同步代码执行完成之后在异步执行视图更新<br>将视图更新的逻辑添加到微任务队列中;<br>类似实现计算属性, 使用scheduler来实现effect延迟执行fn</p>
<p>vue3的视图更新是异步的, 在没有做处理前执行for循环, 视图更新执行了100次, 所以将更新逻辑放到微任务中, 就只执行一次视图更新, 这样优化后视图更新都是异步的了, 所以提供一个nextTick来让用户调用</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Simon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/star/fb8a6346.html">http://example.com/star/fb8a6346.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Like a Star</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mini-vue/">mini-vue</a></div><div class="post_share"><div class="social-share" data-image="/img/category_per.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/star/eb44505a.html" title="资源分享"><img class="cover" src="/img/category_per.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">资源分享</div></div></a></div><div class="next-post pull-right"><a href="/star/e1c7f762.html" title="csp"><img class="cover" src="/img/category_per.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">csp</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Simon</div><div class="author-info__description">月明 ♥ 曦</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Simonduya"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><h2 align="center">记得常来看看</h2> <p align="center"><img src="https://haiyong.site/img/img-blog.csdnimg.cn/f7384c88956d4378b72e47548e19c9f8.gif" width="50" alt="mao"></p> <p align="center">微信号：meiyoune</p> <p align="center">QQ号：2185308330</p></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#reactivity"><span class="toc-number">1.</span> <span class="toc-text">reactivity</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-effect-reactive"><span class="toc-number">1.1.</span> <span class="toc-text">实现 effect + reactive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">核心测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-reactive"><span class="toc-number">1.1.2.</span> <span class="toc-text">实现 reactive</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-effect"><span class="toc-number">1.1.3.</span> <span class="toc-text">实现 effect</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#step1-%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%94%B6%E9%9B%86%E4%BE%9D%E8%B5%96%E6%97%B6%EF%BC%8C-%E4%BC%9A%E6%89%A7%E8%A1%8C%E4%BC%A0%E5%85%A5%E7%9A%84-fn"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">step1 实现第一次收集依赖时， 会执行传入的 fn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#step2-%E5%AE%9E%E7%8E%B0%E6%94%B6%E9%9B%86%E5%92%8C%E8%A7%A6%E5%8F%91%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">step2 实现收集和触发依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84-effect"><span class="toc-number">1.1.4.</span> <span class="toc-text">完善 effect</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#effect-%E8%BF%94%E5%9B%9E%E6%96%B0%E5%87%BD%E6%95%B0-runner"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">effect 返回新函数 runner</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#effect-%E7%9A%84-scheduler-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">effect 的 scheduler 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#effect-%E7%9A%84-stop-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">effect 的 stop 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">代码优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#effect-%E7%9A%84-onStop-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">effect 的 onStop 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96-1"><span class="toc-number">1.1.4.6.</span> <span class="toc-text">代码优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#effect-%E8%BE%B9%E7%BC%98%E6%83%85%E5%86%B5-obj-prop"><span class="toc-number">1.1.4.7.</span> <span class="toc-text">effect 边缘情况, obj.prop++</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-1"><span class="toc-number">1.1.4.7.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-1"><span class="toc-number">1.1.4.7.2.</span> <span class="toc-text">实现代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96-2"><span class="toc-number">1.1.4.7.3.</span> <span class="toc-text">代码优化</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-readonly"><span class="toc-number">1.2.</span> <span class="toc-text">实现 readonly</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.2.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.2.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-isReactive"><span class="toc-number">1.3.</span> <span class="toc-text">实现 isReactive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-3"><span class="toc-number">1.3.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-3"><span class="toc-number">1.3.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-isReadonly"><span class="toc-number">1.4.</span> <span class="toc-text">实现 isReadonly</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-4"><span class="toc-number">1.4.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-4"><span class="toc-number">1.4.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reactive-%E5%92%8C-readonly-%E5%B5%8C%E5%A5%97%E5%AF%B9%E8%B1%A1%E8%BD%AC%E6%8D%A2%E5%8A%9F%E8%83%BD"><span class="toc-number">1.5.</span> <span class="toc-text">reactive 和 readonly 嵌套对象转换功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-5"><span class="toc-number">1.5.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-5"><span class="toc-number">1.5.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-shallowReadonly-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.6.</span> <span class="toc-text">实现 shallowReadonly 功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-6"><span class="toc-number">1.6.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-6"><span class="toc-number">1.6.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-isProxy"><span class="toc-number">1.7.</span> <span class="toc-text">实现 isProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-ref-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.8.</span> <span class="toc-text">实现 ref 功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#happy-path"><span class="toc-number">1.8.1.</span> <span class="toc-text">happy path</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-7"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-7"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#should-be-reactive"><span class="toc-number">1.8.2.</span> <span class="toc-text">should be reactive</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-8"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-8"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#should-make-nested-propertiers-reactive"><span class="toc-number">1.8.3.</span> <span class="toc-text">should make nested propertiers reactive</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-9"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-9"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">实现代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E6%9E%84%E4%BB%A3%E7%A0%81"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">重构代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-isRef"><span class="toc-number">1.9.</span> <span class="toc-text">实现 isRef</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-10"><span class="toc-number">1.9.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-10"><span class="toc-number">1.9.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-unRef"><span class="toc-number">1.10.</span> <span class="toc-text">实现 unRef</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-11"><span class="toc-number">1.10.1.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-11"><span class="toc-number">1.10.2.</span> <span class="toc-text">实现代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-proxyRefs"><span class="toc-number">1.11.</span> <span class="toc-text">实现 proxyRefs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-get"><span class="toc-number">1.11.1.</span> <span class="toc-text">测试代码 get</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-get"><span class="toc-number">1.11.2.</span> <span class="toc-text">实现代码 get</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-set"><span class="toc-number">1.11.3.</span> <span class="toc-text">测试代码 set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-set"><span class="toc-number">1.11.4.</span> <span class="toc-text">实现代码 set</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-computed"><span class="toc-number">1.12.</span> <span class="toc-text">实现 computed</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-%E7%AE%80%E5%8D%95"><span class="toc-number">1.12.1.</span> <span class="toc-text">测试代码-简单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-%E7%AE%80%E5%8D%95"><span class="toc-number">1.12.2.</span> <span class="toc-text">实现代码-简单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-12"><span class="toc-number">1.12.3.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81-12"><span class="toc-number">1.12.4.</span> <span class="toc-text">实现代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#runtime-core"><span class="toc-number">2.</span> <span class="toc-text">runtime-core</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%9D%E5%A7%8B%E5%8C%96-component-%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">实现初始化 component 主流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#render"><span class="toc-number">2.1.1.</span> <span class="toc-text">render</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#patch"><span class="toc-number">2.1.2.</span> <span class="toc-text">patch</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#processComponent"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">processComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mountComponent"><span class="toc-number">2.1.2.1.1.</span> <span class="toc-text">mountComponent</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%87%BA%E4%B8%80%E4%B8%AA-component-instance"><span class="toc-number">2.1.2.1.1.1.</span> <span class="toc-text">抽象出一个 component instance</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#setupComponent-instance"><span class="toc-number">2.1.2.1.1.2.</span> <span class="toc-text">setupComponent(instance);</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#setupRenderEffect-instance-container"><span class="toc-number">2.1.2.1.1.3.</span> <span class="toc-text">setupRenderEffect(instance, container);</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#updateComponent"><span class="toc-number">2.1.2.1.2.</span> <span class="toc-text">updateComponent</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#processElement"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">processElement</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-rollup-%E6%89%93%E5%8C%85%E5%BA%93"><span class="toc-number">2.2.</span> <span class="toc-text">使用 rollup 打包库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.2.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%9D%E5%A7%8B%E5%8C%96-element-%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">实现初始化 element 主流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.4.</span> <span class="toc-text">实现组件代理对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E-setupState-%E4%B8%AD%E5%8F%96%E5%80%BC"><span class="toc-number">2.4.1.</span> <span class="toc-text">从 setupState 中取值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#this-el-%E4%B8%AD%E5%8F%96%E5%80%BC"><span class="toc-number">2.4.2.</span> <span class="toc-text">this.$el 中取值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#this-el-%E4%BB%A3%E7%A0%81%E9%87%8D%E6%9E%84"><span class="toc-number">2.4.3.</span> <span class="toc-text">this.$el 代码重构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-shapeFlags"><span class="toc-number">2.5.</span> <span class="toc-text">实现 shapeFlags</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C%E4%BA%8B%E4%BB%B6%E5%8A%9F%E8%83%BD"><span class="toc-number">2.6.</span> <span class="toc-text">实现注册事件功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6-props-%E5%8A%9F%E8%83%BD"><span class="toc-number">2.7.</span> <span class="toc-text">实现组件 props 功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E4%B8%80-%E9%80%9A%E8%BF%87-setup-%E4%BC%A0%E5%80%BC"><span class="toc-number">2.7.1.</span> <span class="toc-text">功能一 通过 setup 传值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E4%BA%8C-%E5%9C%A8-render-%E4%B8%AD%E9%80%9A%E8%BF%87-this-%E8%AE%BF%E9%97%AE-props-%E4%B8%AD%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">2.7.2.</span> <span class="toc-text">功能二 在 render 中通过 this 访问 props 中的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E4%B8%89-props-%E6%98%AF-shallowreadonly"><span class="toc-number">2.7.3.</span> <span class="toc-text">功能三 props 是 shallowreadonly</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-emit-%E5%8A%9F%E8%83%BD"><span class="toc-number">2.8.</span> <span class="toc-text">实现 emit 功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-slots-%E5%8A%9F%E8%83%BD"><span class="toc-number">2.9.</span> <span class="toc-text">实现 slots 功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Fragment-%E5%92%8C-Text-%E7%B1%BB%E5%9E%8B%E8%8A%82%E7%82%B9"><span class="toc-number">2.10.</span> <span class="toc-text">实现 Fragment 和 Text 类型节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fragment"><span class="toc-number">2.10.1.</span> <span class="toc-text">Fragment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B8%B2%E6%9F%93-Text"><span class="toc-number">2.10.2.</span> <span class="toc-text">实现渲染 Text</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-getCurrentInstance"><span class="toc-number">2.11.</span> <span class="toc-text">实现 getCurrentInstance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-provide-x2F-inject"><span class="toc-number">2.12.</span> <span class="toc-text">实现 provide&#x2F;inject</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E5%99%A8-custom-renderer"><span class="toc-number">2.13.</span> <span class="toc-text">实现自定义渲染器 custom renderer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#renderer-%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="toc-number">2.13.1.</span> <span class="toc-text">renderer 实现分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E5%88%B0-dom-%E5%B9%B3%E5%8F%B0"><span class="toc-number">2.13.2.</span> <span class="toc-text">渲染到 dom 平台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-custom-renderer"><span class="toc-number">2.13.3.</span> <span class="toc-text">实现 custom renderer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0-element-%E6%B5%81%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">2.14.</span> <span class="toc-text">更新 element 流程搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0-props"><span class="toc-number">2.15.</span> <span class="toc-text">更新 props</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#n1-n2-%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC%E5%8F%91%E7%94%9F%E4%BA%86%E5%8F%98%E5%8C%96-gt-%E4%BF%AE%E6%94%B9%E8%AF%A5%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC"><span class="toc-number">2.15.1.</span> <span class="toc-text">n1, n2 属性的值发生了变化 -&gt; 修改该属性的值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A5%E5%B1%9E%E6%80%A7%E4%B8%BA-null-x2F-undefined-gt-%E5%88%A0%E9%99%A4%E8%AF%A5%E5%B1%9E%E6%80%A7%E5%92%8C%E5%80%BC"><span class="toc-number">2.15.2.</span> <span class="toc-text">该属性为 null&#x2F;undefined -&gt; 删除该属性和值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#n1-%E6%9C%89-n2-%E5%88%A0%E9%99%A4%E4%BA%86%E7%9A%84%E5%B1%9E%E6%80%A7-gt-%E5%88%A0%E9%99%A4%E8%AF%A5%E5%B1%9E%E6%80%A7%E5%92%8C%E5%80%BC"><span class="toc-number">2.15.3.</span> <span class="toc-text">n1 有, n2 删除了的属性 -&gt; 删除该属性和值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0-element-%E7%9A%84-children"><span class="toc-number">2.16.</span> <span class="toc-text">更新 element 的 children</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#n1-text-n2-text"><span class="toc-number">2.16.1.</span> <span class="toc-text">n1: text; n2: text;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#n1-array-n2-text"><span class="toc-number">2.16.2.</span> <span class="toc-text">n1: array; n2: text;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#n1-text-n2-array"><span class="toc-number">2.16.3.</span> <span class="toc-text">n1: text; n2: array;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#n1-array-n2-array-%E5%8F%8C%E7%AB%AF%E5%AF%B9%E6%AF%94-diff-%E7%AE%97%E6%B3%95"><span class="toc-number">2.16.4.</span> <span class="toc-text">n1: array; n2: array; 双端对比 diff 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A6%E4%BE%A7%E5%AF%B9%E6%AF%94"><span class="toc-number">2.16.4.1.</span> <span class="toc-text">左侧对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%B3%E4%BE%A7%E5%AF%B9%E6%AF%94"><span class="toc-number">2.16.4.2.</span> <span class="toc-text">右侧对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E7%9A%84%E6%AF%94%E8%80%81%E7%9A%84%E9%95%BF"><span class="toc-number">2.16.4.3.</span> <span class="toc-text">新的比老的长</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4-diff-%E7%AE%97%E6%B3%95"><span class="toc-number">2.16.4.4.</span> <span class="toc-text">完整 diff 算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97%E7%AE%97%E6%B3%95"><span class="toc-number">2.16.4.5.</span> <span class="toc-text">最长递增子序列算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">2.17.</span> <span class="toc-text">实现组件更新功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0nextTick"><span class="toc-number">2.18.</span> <span class="toc-text">实现nextTick</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/star/2a75657e.html" title="this绑定规则">this绑定规则</a><time datetime="2023-08-03T05:47:01.000Z" title="发表于 2023-08-03 13:47:01">2023-08-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/star/fc0587c3.html" title="dailyExercise">dailyExercise</a><time datetime="2023-08-02T06:41:45.000Z" title="发表于 2023-08-02 14:41:45">2023-08-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/star/5a8d6d78.html" title="手写promise">手写promise</a><time datetime="2023-07-29T06:31:35.000Z" title="发表于 2023-07-29 14:31:35">2023-07-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/star/61fb4071.html" title="typescript type-challenages">typescript type-challenages</a><time datetime="2023-07-28T08:56:33.000Z" title="发表于 2023-07-28 16:56:33">2023-07-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/star/eb44505a.html" title="资源分享">资源分享</a><time datetime="2023-07-28T07:55:33.000Z" title="发表于 2023-07-28 15:55:33">2023-07-28</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Simon</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>